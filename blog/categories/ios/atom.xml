<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[分类：ios | BryanFu Blog]]></title>
  <link href="http://helloyokoy.github.io/blog/categories/ios/atom.xml" rel="self"/>
  <link href="http://helloyokoy.github.io/"/>
  <updated>2015-11-07T17:38:59+08:00</updated>
  <id>http://helloyokoy.github.io/</id>
  <author>
    <name><![CDATA[BryanFu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Surge]]></title>
    <link href="http://helloyokoy.github.io/blog/surge/"/>
    <updated>2015-11-02T11:24:57+08:00</updated>
    <id>http://helloyokoy.github.io/blog/surge</id>
    <content type="html"><![CDATA[<p>iOS 9 有个激动人心的新特性 Network Extension 弥补了 iOS 长久以来无法定制底层网络 app 的不足。APN 代理不安全，成本高；虚拟专网速度不佳，爱掉线，阻塞问题严重…</p>

<p><img src="https://g.owind.com/content/images/2015/10/surgelogo.jpg" alt="alt text" title="surge" /></p>

<p>那么对于专业用户来说比较完美的方案必须是安全的，可低成本的，最大网络速度，无连接状态，国内外分流完美的 iOS 方案，那么现在这个堕落的愿望已经实现了，感谢苹果公司这么给(chi)力(dao)的 API 和 app 开发大牛。</p>

<p>Surge.app （App Store）是一款给专业用户使用的网络调试工具，使用比较复杂。它的工作原理是使用 packet tunnel provider，然后给系统套上一个代理，后端转发支持 http 代理，SSL 代理，和 Socks 代理。如果 app 尊重系统代理，就会走这个代理，如果不尊重，我们也可以通过规则强制流量走系统 tun 设备达到支持全部 app 的目的。用代理的好处是可以跟踪和调试网络，容易分流，ACL 功能更多，弹性更大更方便。</p>

<!--more-->

<p>简单的开始可以直接导入一份 conf 文件（URL 或者 iTunes），例如<a href="https://gist.github.com/janlay/b57476c72a93b7e622a6" title="link">这里</a>的，对于不求甚解的用户来说你可以直接使用完事（但是你还是要改改服务器地址用户名什么的。。或者直接从供应商处获取导入 URL）。</p>

<p>配置的结构大概是这样，对于专业用户来说，理解应该不难</p>

<p><figure class='code'><figcaption><span> (rules)</span> <a href='/downloads/code/rules'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'><span class="k">[General]</span>
</span><span class='line'><span class="c1"># warning, notify, info, verbose</span>
</span><span class='line'><span class="na">loglevel</span> <span class="o">=</span> <span class="s">notify</span>
</span><span class='line'>
</span><span class='line'><span class="k">[Proxy]</span>
</span><span class='line'><span class="c1"># http, https, socks5</span>
</span><span class='line'><span class="c1"># SSLedge 使用 https，老式 APNp 用 http</span>
</span><span class='line'><span class="na">Proxy</span> <span class="o">=</span> <span class="s">https, server, port, username, password, ciphers </span>
</span><span class='line'>
</span><span class='line'><span class="k">[Rule]</span>
</span><span class='line'><span class="c1"># 域名关键字，干掉不想要的请求</span>
</span><span class='line'><span class="err">DOMAIN-KEYWORD,umeng.co,REJECT</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 常用网站优先匹配，加快速度。使用代理转发，完全没有 CDN 被干扰的问题~</span>
</span><span class='line'><span class="err">DOMAIN-SUFFIX,cn,DIRECT</span>
</span><span class='line'><span class="err">DOMAIN-SUFFIX,qq.com,DIRECT</span>
</span><span class='line'><span class="err">DOMAIN-SUFFIX,ls.apple.com,DIRECT</span>
</span><span class='line'><span class="err">DOMAIN-SUFFIX,apple.com,Proxy</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 强制这些不尊重系统代理的请求走 packet-tunnel-provider，解决 Twitter.app 和 Mail.app 收发邮件问题</span>
</span><span class='line'><span class="err">DOMAIN-KEYWORD,twitter,Proxy,force-remote-dns</span>
</span><span class='line'><span class="err">DOMAIN-KEYWORD,gmail,Proxy,force-remote-dns</span>
</span><span class='line'><span class="c1"># instagram.app 也没问题</span>
</span><span class='line'><span class="err">DOMAIN-KEYWORD,instagram,Proxy,force-remote-dns</span>
</span><span class='line'><span class="c1"># Telegram.app 也没问题</span>
</span><span class='line'><span class="err">IP-CIDR,91.108.56.0/22,Proxy,force-remote-dns</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># LAN</span>
</span><span class='line'><span class="err">IP-CIDR,192.168.0.0/16,DIRECT</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 其余的请求使用 GEOIP 判断服务器所在地，如果是国内的，走直连，搞定</span>
</span><span class='line'><span class="err">GEOIP,CN,DIRECT</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 最后 Matchall，丢给代理</span>
</span><span class='line'><span class="err">FINAL,Proxy</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>通过规则定义和组合，必然可以满足专业用户的需求，非常强大。配置可以使用 app 自带的 GUI，当然也有文本编辑方式。</p>

<p>由于 Surge 的核心和是个 http proxy，有些处理不了的请求我们可以强制 bypass 掉，走系统接口，这个可以在代理设置-高级处设置，如果你不太懂，请不要随意设置。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS9 适配]]></title>
    <link href="http://helloyokoy.github.io/blog/ios9-adaption/"/>
    <updated>2015-10-27T12:44:03+08:00</updated>
    <id>http://helloyokoy.github.io/blog/ios9-adaption</id>
    <content type="html"><![CDATA[<h2 id="ios9atshttps">1. iOS9网络适配_ATS：改用更安全的HTTPS</h2>

<p>[摘要]为了强制增强数据访问安全， iOS9 默认会把 <del>所有的http请求</del> 所有从<code>NSURLConnection</code> 、 <code>CFURL</code> 、 <code>NSURLSession</code>发出的 HTTP 请求，都改为 HTTPS 请求：iOS9.x-SDK编译时，默认会让所有从<code>NSURLConnection</code> 、 <code>CFURL</code> 、 <code>NSURLSession</code>发出的 HTTP 请求统一采用TLS 1.2 协议。因为 AFNetworking 现在的版本底层使用了 <code>NSURLConnection</code> ，众多App将被影响（基于iOS8.x-SDK的App不受影响）。服务器因此需要更新，以解析相关数据。如不更新，可通过在 Info.plist 中声明，倒退回不安全的网络请求。而这一做法，官方文档称为ATS，全称为App Transport Security，是iOS9的一个新特性。</p>

<p>一个符合 ATS 要求的 HTTPS，应该满足如下条件：</p>

<ol>
  <li>Transport Layer Security协议版本要求TLS1.2以上</li>
  <li>服务的Ciphers配置要求支持Forward Secrecy等</li>
  <li>证书签名算法符合ATS要求等</li>
</ol>

<p>官方文档 <a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/index.html#//apple_ref/doc/uid/TP40016240"> <strong><em>App Transport Security Technote</em></strong> </a> 对ATS 的介绍：</p>

<p><img src="http://i58.tinypic.com/ajsf0j.jpg" alt="enter image description here" /></p>

<!--more-->

<p>注：有童鞋反映：服务器已支持TLS 1.2 SSL ，但iOS9上还是不行，还要进行本文提出的适配操作。</p>

<p>那是因为：要注意 App Transport Security 要求 TLS 1.2，而且它要求站点使用支持forward secrecy协议的密码。证书也要求是符合ATS规格的，ATS只信任知名CA颁发的证书，小公司所使用的 self signed certificate，还是会被ATS拦截。。因此慎重检查与你的应用交互的服务器是不是符合ATS的要求非常重要。对此，建议使用下文中给出的NSExceptionDomains，并将你们公司的域名挂在下面。下文也会详细描述该问题。</p>

<p>官方文档 <a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/index.html#//apple_ref/doc/uid/TP40016240"> <strong><em>App Transport Security Technote</em></strong> </a> 对CA颁发的证书要求：</p>

<blockquote>
  <p>Certificates must be signed using a SHA256 or better signature hash algorithm, with either a 2048 bit or greater RSA key or a 256 bit or greater Elliptic-Curve (ECC) key.
Invalid certificates result in a hard failure and no connection</p>
</blockquote>

<p>在讨论之前，跟往常一样，先说下iOS程序猿们最关心的问题：</p>

<h3 id="section">跟我有毛关系？需要我加班吗？！</h3>

<p>首先咱们来看下业内对Apple这一做法的评论：</p>

<p><img src="https://i.imgur.com/Q17QDG0.png" alt="enter image description here" /></p>

<p>这是某社交App上讨论，看来业内还是吐槽声和肯定声同在。</p>

<p>结论是：</p>

<blockquote>
  <p>跟你很有关系，加班吧，少年！</p>
</blockquote>

<p>书归正传【严肃脸】，我们正式讨论下 WHAT，WHY，HOW：</p>

<ol>
  <li>WHAT（什么是SSL/TLS？跟HTTP和HTTPS有什么关系）</li>
  <li>WHY（以前的HTTP不是也能用吗？为什么要用SSL/TLS？！Apple是不是又在反人类？）</li>
  <li>HOW（如何适配？—弱弱地问下：加班要多久？）</li>
</ol>

<h3 id="whatssltlshttphttps">WHAT（什么是SSL/TLS？跟HTTP和HTTPS有什么关系）</h3>

<p>什么是SSL/TLS？
SSL你一定知道，在此不做赘述。主要说下什么是TLS，还有跟HTTP和HTTPS有什么关系。</p>

<p>TLS 是 SSL 新的别称：</p>

<p>“TLS1.0”之于“SSL3.1”，犹“公元2015”之于“民国104”，“一千克”之于“一公斤”：称呼不同，意思相同。</p>

<p>SSL 3.0版本之后的迭代版本被重新命名为TLS 1.0：<strong>TLS 1.0＝SSL 3.1</strong>。所以我们平常也经常见到 “SSL/TLS” 这种说法。</p>

<p>目前，应用最广泛的是TLS 1.0，接下来是SSL 3.0。目前主流浏览器都已经实现了TLS 1.2的支持。</p>

<p>常用的有下面这些：</p>

<ul>
  <li>SSL 2.0</li>
  <li>SSL 3.0</li>
  <li>TLS 1.0 (SSL 3.1)</li>
  <li>TLS 1.1 (SSL 3.1)</li>
  <li>TLS 1.2 (SSL 3.1)</li>
</ul>

<p>那为什么标题是“使用HTTPS”而没有提及SSL和TLS什么事？
“SSL/TLS”跟HTTP和HTTPS有什么关系？</p>

<p>要理解这个，要看下他们之间的关系：</p>

<blockquote>
  <p>HTTP+SSL/TLS+TCP = HTTPS</p>
</blockquote>

<p><img src="http://www.zytrax.com/tech/survival/ssl-layers.gif" alt="HTTP+SSL/TLS+TCP" /></p>

<p>或者</p>

<blockquote>
  <p>HTTPS = “HTTP over SSL”</p>
</blockquote>

<p>也就是说：</p>

<blockquote>
  <p>Apple让你的HTTP采用SSL/TLS协议，就是让你从HTTP转到HTTPS。而这一做法，官方文档称为ATS，全称为App Transport Security。</p>
</blockquote>

<h3 id="whyhttpssltlsapple">WHY（以前的HTTP不是也能用吗？为什么要用SSL/TLS？Apple是不是又在反人类？）</h3>

<blockquote>
  <p>不使用SSL/TLS的HTTP通信，就是不加密的通信！</p>
</blockquote>

<p>不使用SSL/TLS的HTTP通信，所有信息明文传播，带来了三大风险：</p>

<ol>
  <li>窃听风险（eavesdropping）：第三方可以获知通信内容。</li>
  <li>篡改风险（tampering）：第三方可以修改通信内容。</li>
  <li>冒充风险（pretending）：第三方可以冒充他人身份参与通信。</li>
</ol>

<p>SSL/TLS协议是为了解决这三大风险而设计的，希望达到：
 1. 所有信息都是加密传播，第三方无法窃听。
 2. 具有校验机制，一旦被篡改，通信双方会立刻发现。
 3. 配备身份证书，防止身份被冒充。</p>

<p>SSL/TLS的作用，打个比方来讲：</p>

<p>如果原来的 HTTP 是塑料水管，容易被戳破；那么如今新设计的 HTTPS 就像是在原有的塑料水管之外，再包一层金属水管（SSL/TLS协议）。一来，原有的塑料水管照样运行；二来，用金属加固了之后，不容易被戳破。</p>

<h3 id="how---">HOW（如何适配？—弱弱地问下：加班要多久？）</h3>

<p>正如文章开头所说：</p>

<blockquote>
  <p>TLS 1.2 协议 强制增强数据访问安全 系统 Foundation 框架下的“相关网络请求”将不再默认使用 HTTP 等不安全的网络协议，而默认采用 TLS 1.2。服务器因此需要更新，以解析相关数据。如不更新，可通过在 Info.plist 中声明，倒退回不安全的网络请求。</p>
</blockquote>

<p>总之：</p>

<blockquote>
  <p>要么咱们iOS程序猿加班，要么后台加班：</p>
</blockquote>

<p>方案一：立即让公司的服务端升级使用TLS 1.2，以解析相关数据。</p>

<p>方案二：虽Apple不建议，但可通过在 Info.plist 中声明，倒退回不安全的网络请求依然能让App访问指定http，甚至任意的http，具体做法见gif图，示例Demo见 <a href="https://github.com/ChenYilong/iOS9AdaptationTips">Demo1</a></p>

<p><img src="https://github.com/ChenYilong/iOS9AdaptationTips/blob/master/Demo1_iOS9网络适配_改用更安全的HTTPS/微博%40iOS程序犭袁/http问题.gif" alt="enter image description here" /></p>

<p>这也是官方文档和WWDC给出的解决方案：</p>

<ol>
  <li>
    <p><a href="https://developer.apple.com/library/prerelease/ios/releasenotes/General/WhatsNewIniOS/Articles/iOS9.html#//apple_ref/doc/uid/TP40016198-DontLinkElementID_13">Apple官方文档</a>  <img src="https://i.imgur.com/eTgSHZY.png" alt="enter image description here" /></p>
  </li>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=703">WWDC Session： “Networking with NSURLSession” session（ 【WWDC 2015 session 703, “Privacy and Your App” O网页链接 】, 时间在30:18左右）</a></p>
  </li>
</ol>

<p><img src="https://i.imgur.com/Tc0fS6p.jpg" alt="enter image description here" /></p>

<p><img src="https://i.imgur.com/v2Tskwh.jpg" alt="enter image description here" /></p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*9-VeRXU5SAI6lLZeWLI0hQ.png" alt="enter image description here" /></p>

<p>即使你的应用使用的是：你没有权限控制的CDN (Content Delivery Network)，而且它不支持HTTPS！</p>

<p>也别担心，Apple都替你考虑好了：</p>

<p><img src="http://i61.tinypic.com/ae9tgj.jpg" alt="enter image description here" />
 正如你在上图中看到的：苹果官方提供了一些可选配置项来决定是否开启ATS模式，也就是可以选择开启或者不开启。</p>

<p>开发者可以针对某些确定的URL不使用ATS，这需要在工程中的info.plist中标记NSExceptionDomains。在NSExceptionDomains字典中，可以显式的指定一些不使用ATS的URL。这些你可以使用的例子可以是:</p>

<ul>
  <li>
    <p>NSIncludesSubdomains</p>
  </li>
  <li>
    <p>NSExceptionAllowInsecureHTTPLoads</p>
  </li>
  <li>
    <p>NSExceptionRequiresForwardSecrecy</p>
  </li>
  <li>
    <p>NSExceptionMinimumTLSVersion</p>
  </li>
  <li>
    <p>NSThirdPartyExceptionAllowsInsecureHTTPLoads</p>
  </li>
  <li>
    <p>NSThirdPartyExceptionMinimumTLSVersion</p>
  </li>
  <li>
    <p>NSThirdPartyExceptionRequiresForwardSecrecy</p>
  </li>
</ul>

<p>这些关键字使我们可以更加细致的设置针对不使用ATS的域名情况下禁用ATS或者一些特殊的ATS选项。</p>

<p>你可能注意到一些关键字像是使用了一些其他关键字中的词但是在前面加上了”ThirdParty”字样，比如列表里最后三个：</p>

<ul>
  <li>
    <p>NSThirdPartyExceptionAllowsInsecureHTTPLoads</p>
  </li>
  <li>
    <p>NSThirdPartyExceptionMinimumTLSVersion</p>
  </li>
  <li>
    <p>NSThirdPartyExceptionRequiresForwardSecrecy</p>
  </li>
</ul>

<p>在功能上，这些关键字与不含有”ThirdParty”的关键字有同样的效果。而且实际运行中所调用的代码将会完全忽略是否使用”ThirdParty”关键字。你应该使用适用于你的场景的关键字而不必过多考虑这些。</p>

<p>关于App Transport Security，每个应用都属于4个大类当中的一类。我们来看看每一个大类都是怎样影响应用的。</p>

<table>
  <thead>
    <tr>
      <th>–</th>
      <th>分类名</th>
      <th>解释</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1.</td>
      <td>HTTPS Only （只有HTTPS，所有情况下都使用ATS）</td>
      <td>如果你的应用只基于支持HTTPS的服务器，那么你太幸运了。你的应用不需要做任何改变。但是，注意App Transport Security要求TLS 1.2而且它要求站点使用支持forward secrecy协议的密码。证书也要求是符合ATS规格的。因此慎重检查与你的应用交互的服务器是不是符合ATS的要求非常重要。</td>
    </tr>
    <tr>
      <td>2.</td>
      <td>Mix &amp; Match（混合）</td>
      <td>你的应用与一个不符合ATS要求的服务器工作是很有可能的。在这种情况下，你需要告诉操作系统哪些站点是涉及到的然后在你的应用的 Info.plist文件中指明哪些要求没有达到。</td>
    </tr>
    <tr>
      <td>3.</td>
      <td>Opt Out（禁用ATS）</td>
      <td>如果你在创建一个网页浏览器，那么你有一个更大的麻烦。因为你不可能知道你的用户将要访问那个网页，你不可能指明这些网页是否支持ATS要求且在HTTPS上传输。在这种情况下，除了全部撤销 App Transport Security 没有其它办法。</td>
    </tr>
    <tr>
      <td>4.</td>
      <td>Opt Out With Exceptions（除特殊情况外，都不使用ATS）</td>
      <td>当你的应用撤消了App Transport Security,，但同时定义了一些例外。这非常有用就是当你的应用从很多的服务器上取数据，但是也要与一个你可控的API交互。在这种情况下，在应用的Info.plist文件中指定任何加载都是被允许的，但是你也指定了一个或多个例外来表明哪些是必须要求 App Transport Security的。</td>
    </tr>
  </tbody>
</table>

<p>下面分别做一下介绍：</p>

<h4 id="https-only-httpsats">1.HTTPS Only （只有HTTPS，所有情况下都使用ATS）</h4>
<p>如果你的应用只基于支持HTTPS的服务器，那么你太幸运了。你的应用不需要做任何改变。</p>

<p>唯一需要做的事情就是使用  <code>NSURLSession</code> 。如果你的开发目标是iOS 9或者 OS X EI Capitan之后，ATS 的最佳实践将会应用到所有基于 <code>NSURLSession</code> 的网络。</p>

<p>但也有人遇到过这样的疑惑：服务器已支持TLS 1.2 SSL ，但iOS9上还是不行，还要进行本文提出的适配操作。</p>

<p>那是因为：要注意 App Transport Security 要求 TLS 1.2，而且它要求站点使用支持forward secrecy协议的密码。证书也要求是符合ATS规格的，ATS只信任知名CA颁发的证书，小公司所使用的 self signed certificate，还是会被ATS拦截。。因此慎重检查与你的应用交互的服务器是不是符合ATS的要求非常重要。对此，建议使用下文中给出的NSExceptionDomains，并将你们公司的域名挂在下面。</p>

<p>官方文档 <a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/index.html#//apple_ref/doc/uid/TP40016240"> <strong><em>App Transport Security Technote</em></strong> </a> 对CA颁发的证书要求：</p>

<blockquote>
  <p>Certificates must be signed using a SHA256 or better signature hash algorithm, with either a 2048 bit or greater RSA key or a 256 bit or greater Elliptic-Curve (ECC) key.
Invalid certificates result in a hard failure and no connection</p>
</blockquote>

<h4 id="mix--match">2.Mix &amp; Match（混合）</h4>
<p>你的应用与一个不符合ATS要求的服务器工作是很有可能的，</p>

<p>当你遇到以下三个不符合 ATS 要求的服务器的域名时：</p>

<ol>
  <li>api.insecuredomain.com</li>
  <li>cdn.domain.com</li>
  <li>thatotherdomain.com</li>
</ol>

<p>你可以分别设置如下：</p>

<ol>
  <li>api.insecuredomain.com</li>
</ol>

<p>Info.plist 配置中的XML源码如下所示:</p>

<p>```XML
    <key>NSAppTransportSecurity</key>
    <dict>
        <key>NSExceptionDomains</key>
        <dict>
            <key>api.insecuredomain.com</key>
            <dict></dict></dict></dict></p>

<pre><code>            &lt;!--允许App进行不安全的HTTP请求--&gt;
            &lt;key&gt;NSExceptionAllowsInsecureHTTPLoads&lt;/key&gt;
            &lt;true/&gt;
            
            &lt;!--适用于这个特定域名下的所有子域--&gt;
            &lt;key&gt;NSIncludesSubdomains&lt;/key&gt;
            &lt;true/&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
&lt;/dict&gt;  ```
</code></pre>

<p>在 plist 文件里显示如下：</p>

<p><img src="http://i59.tinypic.com/fxtk0j.jpg" alt="enter image description here" /></p>

<p>我们定义的第一个“例外”（Exception）告诉ATS当与这个子域交互的时候撤销了必须使用HTTPS的要求。注意这个仅仅针对在“例外”（Exception）中声明了的子域。非常重要的一点是要理解NSExceptionAllowsInsecureHTTPLoads关键字并不仅仅只是与使用HTTPS相关。这个“例外”（Exception）指明了对于那个域名，所有的App Transport Security的要求都被撤销了。</p>

<ol>
  <li>cdn.domain.com
 Info.plist 配置中的XML源码如下所示:</li>
</ol>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;code&gt;</span>XML
</span><span class='line'>	<span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAppTransportSecurity<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>	<span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>		<span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionDomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>		<span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>			<span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>cdn.somedomain.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>			<span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>				<span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSThirdPartyExceptionMinimumTLSVersion<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>				<span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>TLSv1.1<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
</span><span class='line'>			<span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>		<span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>	<span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>在 plist 文件里显示如下：</p>

<p><img src="http://i58.tinypic.com/29atm5k.jpg" alt="enter image description here" /></p>

<p>很可能你的应用是与一个支持HTTPS传输数据的服务器交互，但是并没有使用TLS 1.2或更高。在这种情况下，你定义一个“例外”（Exception），它指明应该使用的最小的TLS的版本。这比完全撤销那个域名的App Transport Security要更好更安全。</p>

<ol>
  <li>thatotherdomain.com</li>
</ol>

<p>Info.plist 配置中的XML源码如下所示:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;code&gt;</span>XML
</span><span class='line'>       <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAppTransportSecurity<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionDomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>thatotherdomain.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>!--适用于这个特定域名下的所有子域--<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSIncludesSubdomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>!--扩展可接受的密码列表：这个域名可以使用不支持 forward secrecy 协议的密码--<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionRequiresForwardSecrecy<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>false/<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>!--允许App进行不安全的HTTP请求--<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionAllowsInsecureHTTPLoads<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>!--在这里声明所支持的 TLS 最低版本--<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionMinimumTLSVersion<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>TLSv1.1<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>在 plist 文件里显示如下：</p>

<p><img src="http://i61.tinypic.com/w6xn43.jpg" alt="enter image description here" /></p>

<p><code>NSIncludesSubdomains</code> 关键字告诉 App Transport Security 这个“例外”（Exception）适用于这个特定域名的所有子域。这个“例外”（Exception）还进一步通过扩展可接受的密码列表来定义这个域名可以使用不支持forward secrecy( <code>NSExceptionRequiresForwardSecrecy</code> )  协议的密码。想了解更多关于forward secrecy的信息，推荐去看官方文档  <a href="https://developer.apple.com/library/prerelease/mac/technotes/App-Transport-Security-Technote/index.html"> <strong><em>Apple’s technote</em></strong> </a> 。</p>

<p>如果你的App中同时用到了这三个域名，那么应该是这样：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;code&gt;</span>XML
</span><span class='line'>     <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAppTransportSecurity<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionDomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>api.insecuredomain.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionAllowsInsecureHTTPLoads<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>false/<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>cdn.somedomain.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSThirdPartyExceptionMinimumTLSVersion<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>TLSv1.1<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>thatotherdomain.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSIncludesSubdomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionRequiresForwardSecrecy<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                    <span class="ni">&amp;lt;</span>false/<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><img src="http://i61.tinypic.com/13ynggk.jpg" alt="enter image description here" /></p>

<h4 id="opt-outats">3. Opt Out（禁用ATS）</h4>
<p>上面是比较严谨的做法，指定了能访问哪些特定的HTTP。当然也有暴力的做法：
彻底倒退回不安全的HTTP网络请求，能任意进行HTTP请求，比如你在开发一款浏览器App，或者你想偷懒，或者后台想偷懒，或者公司不给你升级服务器。。。</p>

<p>你可以在Info.plist 配置中改用下面的XML源码：
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;code&gt;</span>XML
</span><span class='line'>    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAppTransportSecurity<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>!--彻底倒退回不安全的HTTP网络请求，能任意进行HTTP请求 (不建议这样做)--<span class="ni">&amp;gt;</span>
</span><span class='line'>	    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAllowsArbitraryLoads<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>	    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>在 plist 文件里显示如下：</p>

<p><img src="http://i57.tinypic.com/9uq2c7.jpg" alt="enter image description here" /></p>

<h4 id="opt-out-with-exceptionsats">4. Opt Out With Exceptions（除特殊情况外，都不使用ATS）</h4>

<p>上面已经介绍了三种情景，还有一种可能你也会遇到：</p>

<p>当你的应用撤消了App Transport Security,，但同时定义了一些“例外”（Exception）。当你的应用从很多的服务器上取数据，但是也要与一个你可控的API交互。在这种情况下，在应用的Info.plist文件中指定任何加载都是被允许的，但是你也指定了一个或多个“例外”（Exception）来表明哪些是必须要求 App Transport Security的。下面是Info.plist文件应该会有的内容：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> ```XML<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;key&gt;</span>NSAppTransportSecurity<span class="nt">&lt;/key&gt;</span>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span>    <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSAllowsArbitraryLoads<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionDomains<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>api.tutsplus.com<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>NSExceptionAllowsInsecureHTTPLoads<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
</span><span class='line'>                <span class="ni">&amp;lt;</span>false/<span class="ni">&amp;gt;</span>
</span><span class='line'>            <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>  ```
</span></code></pre></td></tr></table></div></figure>
</code></pre>

<p>在 plist 文件里显示如下：</p>

<p><img src="http://i62.tinypic.com/de1rw9.jpg" alt="enter image description here" /></p>

<p><del>【注：以上在Info.plist配置中的做法已经验证可行，但目前Apple的prerelease版本的官方文档并未提及Info.plist中配置的代码，我将密切关注官方文档，如有提及，再来更新[本文](https://github.com/ChenYilong/iOS9AdaptationTips) .你若发现官方文档有提及了，也可在[微博@iOS程序犭袁](http://weibo.com/luohanchenyilong/)通知下我。】（官方文档已经有阐述）</del></p>

<h4 id="certificate-transparency">Certificate Transparency</h4>

<p>虽然ATS大多数安全特性都是默认可用的，Certificate Transparency 是必须设置的。如果你有支持Certificate Transparency的证书，你可以检查NSRequiresCertificateTransparency关键字来使用Certificate Transparency。再次强调，如果你的证书不支持Certificate Transparency，此项需要设置为不可用。</p>

<p>如果需要调试一些由于采用了ATS而产生的问题，需要设置CFNETWORK_DIAGNOSTICS为1，这样就会打印出包含被访问的URL和ATS错误在内的NSURLSession错误信息。要确保处理了遇到的所有的错误消息，这样才能使ATS易于提高可靠性和扩展性。</p>

<h4 id="q-a">Q-A</h4>

<p>Q：我用xcode7编译的app，如果不在plist里面加关键字说明，ios9下不能进行网络请求，因为我们服务器并不支持 TLS 1.2 ，我要是直接下载app store上的，什么也没有做，也是能正常网络请求。</p>

<p>A：本文中所罗列的新特性，多数情况下指的是 iOS9.X-SDK 新特性，AppStore 的版本是基于 iOS8.X-SDK或 iOS7.X-SDK，所以并不受 iOS9新特性约束。也就是说：<strong>Xcode7给iOS8打设备包可以请求到网络，Xcode7给iOS9设备打的包请求不到网络，Xcode7和iOS9缺一不可，才需要网络适配ATS。</strong></p>

<p>那么，如何确认自己项目所使用的 SDK？在Targets-&gt;Build Setting–&gt;Architectures</p>

<p><img src="http://i58.tinypic.com/amsa9u.jpg" alt="enter image description here" /></p>

<p>Q：服务器已支持TLS 1.2 SSL ，但iOS9上还是不行，还要进行本文提出的适配操作。</p>

<p>A：那是因为：要注意 App Transport Security 要求 TLS 1.2，而且它要求站点使用支持forward secrecy协议的密码。证书也要求是符合ATS规格的，ATS只信任知名CA颁发的证书，小公司所使用的 self signed certificate，还是会被ATS拦截。。因此慎重检查与你的应用交互的服务器是不是符合ATS的要求非常重要。对此，建议使用下文中给出的NSExceptionDomains，并将你们公司的域名挂在下面。</p>

<p>官方文档 <a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/index.html#//apple_ref/doc/uid/TP40016240"> <strong><em>App Transport Security Technote</em></strong> </a> 对CA颁发的证书要求：</p>

<blockquote>
  <p>Certificates must be signed using a SHA256 or better signature hash algorithm, with either a 2048 bit or greater RSA key or a 256 bit or greater Elliptic-Curve (ECC) key.
Invalid certificates result in a hard failure and no connection</p>
</blockquote>

<p>Q：我使用的是第三方的网络框架，比如 AFNetworking 、ASIHTTPRequest、CFSocket 等，这个有影响没有？</p>

<p>A： AFNetworking 有影响，其它没影响。</p>

<p>ATS 是只针对 <code>NSURLConnection</code> 、 <code>CFURL</code> 、 <code>NSURLSession</code> ，如果底层涉及到这三个类就会有影响。</p>

<p>现在的 AFNetworking 的 AFHTTPRequestOperationManager 实现是使用的 <code>NSURLConnection</code> 。</p>

<p>但 AFNetworking 也有更新计划，移除 <code>NSURLConnection</code> 相关API，迁移到 AFHTTPSessionManager ，但还未执行，详情见：<a href="https://github.com/AFNetworking/AFNetworking/issues/2806">https://github.com/AFNetworking/AFNetworking/issues/2806</a>。</p>

<p>Q：试了一下禁用 ATS 的方法 但是还是无法联网 仍然提示要使用https?</p>

<blockquote>
  <p>App Transport Security has blocked a cleartext HTTP (http://) resource load since it is insecure. Temporary exceptions can be configured via your app's Info.plist file.</p>
</blockquote>
<p>&lt;/p&gt;The resource could not be loaded because the App Transport Security policy requires the use of a secure connection.</p>

<p>A：遇到这类问题，90%是出现在“一个 Project 多 Target ”的情况下，所以
请确保你修改的，确实是你的 Target 所属的 Info.plist ！</p>

<p>如何确认？请前往这里，确认你 Target 所属的 Info.plist 究竟是哪个：</p>

<p>Project -&gt; Your Target -&gt; Build Settings -&gt; Info.plist File</p>

<p><img src="http://i60.tinypic.com/sbrfrl.jpg" alt="enter image description here" /></p>

<p>或者更直截了当一点，直接修改：</p>

<p>Project -&gt; Your Target —&gt;info－&gt; Custom iOS target properties－&gt; 添加禁用 ATS 的属性</p>

<p><img src="http://i60.tinypic.com/zvbt7b.jpg" alt="enter image description here" /></p>

<p>还有一种可能性是：禁用 ATS 的代码粘贴进 plist 时，位置不对，可以尝试放在 diwuhang</p>

<p>Q：我的项目是“一个 Project 多 Target ”，按照本文禁用 ATS 的方法，是不是每个 Info.plist 都要修改？</p>

<p>A：不需要，用到哪个 Target 修改哪个的 Info.plist ，Target 是独立的，不受其他 Target 的影响，也不会影响其他 Target。</p>

<p>Q：如何检测我们公司 HTTPS 是否符合 ATS 的要求？</p>

<p>A：
如果你的 App 的服务也在升级以适配ATS要求，可以使用如下的方式进行校验：</p>

<p>在OS X EI Capitan系统的终端中通过nscurl命令来诊断检查你的HTTPS服务配置是否满足Apple的ATS要求:</p>

<p><code>Objective-C
 $ nscurl --verbose --ats-diagnostics https://&lt;your_server_domain&gt;
</code></p>

<p>当然，你也可以让公司服务端的同事参考Apple提供官方指南App Transport Security Technote进行服务的升级配置以满足ATS的要求：</p>

<p>一个符合 ATS 要求的 HTTPS，应该满足如下条件：</p>

<ol>
  <li>Transport Layer Security协议版本要求TLS1.2以上</li>
  <li>服务的Ciphers配置要求支持Forward Secrecy等</li>
  <li>证书签名算法符合ATS要求等</li>
</ol>

<h2 id="demo2ios9">2.Demo2_iOS9新特性_更灵活的后台定位</h2>

<p>【iOS9在定位的问题上，有一个坏消息一个好消息】坏消息：如果不适配iOS9，就不能偷偷在后台定位（不带蓝条，见图）！好消息：将允许出现这种场景：同一App中的多个location manager：一些只能在前台定位，另一些可在后台定位，并可随时开启或者关闭特定location manager的后台定位。</p>

<p>如果没有请求后台定位的权限，也是可以在后台定位的，不过会带蓝条：
 ![enter image description here][9]
  [9]: https://i.imgur.com/UoqGHlG.png</p>

<p>如何偷偷在后台定位：请求后台定位权限：</p>

<pre><code> // 1. 实例化定位管理器
_locationManager = [[CLLocationManager alloc] init];
// 2. 设置代理
_locationManager.delegate = self;
// 3. 定位精度
[_locationManager setDesiredAccuracy:kCLLocationAccuracyBest];
// 4.请求用户权限：分为：⓵只在前台开启定位⓶在后台也可定位，
//注意：建议只请求⓵和⓶中的一个，如果两个权限都需要，只请求⓶即可，
//⓵⓶这样的顺序，将导致bug：第一次启动程序后，系统将只请求⓵的权限，⓶的权限系统不会请求，只会在下一次启动应用时请求⓶
if ([[[UIDevice currentDevice] systemVersion] floatValue] &gt;= 8) {
    //[_locationManager requestWhenInUseAuthorization];//⓵只在前台开启定位
    [_locationManager requestAlwaysAuthorization];//⓶在后台也可定位
}
// 5.iOS9新特性：将允许出现这种场景：同一app中多个location manager：一些只能在前台定位，另一些可在后台定位（并可随时禁止其后台定位）。
if ([[[UIDevice currentDevice] systemVersion] floatValue] &gt;= 9) {
    _locationManager.allowsBackgroundLocationUpdates = YES;
}
// 6. 更新用户位置
[_locationManager startUpdatingLocation];
</code></pre>

<p>但是如果照着这种方式尝试，而没有配置Info.plist，100%你的程序会崩溃掉，并报错：</p>

<blockquote>
  <p>*** Assertion failure in -[CLLocationManager setAllowsBackgroundLocationUpdates:], /BuildRoot/Library/Caches/com.apple.xbs/Sources/CoreLocationFramework_Sim/CoreLocation-1808.1.5/Framework/CoreLocation/CLLocationManager.m:593</p>
</blockquote>

<p>这个问题，有两种方式可以解决：</p>

<p>第一种：</p>

<p>要将  Info.plist 配置如下：
 <img src="https://i.imgur.com/MAoKbUe.png" alt="enter image description here" /></p>

<p>对应的 Info.plist 的XML源码是：</p>

<pre><code>&lt;key&gt;NSLocationAlwaysUsageDescription&lt;/key&gt;
&lt;string&gt;微博@iOS程序犭袁 请求后台定位权限&lt;/string&gt;

&lt;key&gt;UIBackgroundModes&lt;/key&gt;
&lt;array&gt;
    &lt;string&gt;location&lt;/string&gt;
&lt;/array&gt;
</code></pre>

<p>第二种：</p>

<p>在对应 target 的 Capabilities -&gt; Background Modes -&gt; 开启 Location Updates</p>

<p><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2014/12/background_modes.png" alt="enter image description here" /></p>

<h2 id="section-1">3.企业级分发</h2>

<p>有两处变化：</p>

<ol>
  <li>iOS9以后，企业级分发ipa包将遭到与Mac上dmg安装包一样的待遇：默认不能安装，也不再出现“信任按钮”</li>
  <li>iOS9以后，企业分发时可能存在：下载的ipa包与网页两者的 bundle ID 无法匹配而导致下载失败的情况</li>
</ol>

<h3 id="ios9ipamacdmg">1. iOS9以后，企业级分发ipa包将遭到与Mac上dmg安装包一样的待遇：默认不能安装，也不再出现“信任按钮”</h3>

<p>iOS9之前，企业级分发十分方便：点击App出现“信任按钮”，</p>

<p><img src="https://i.imgur.com/aSmM8bk.png" alt="enter image description here" /></p>

<p>iOS9以后，企业级分发ipa包将遭到与Mac上dmg安装包一样的待遇：默认不能安装，也不再出现“信任按钮”</p>

<p><img src="http://i58.tinypic.com/2zecm83.jpg" alt="enter image description here" /></p>

<p>必须让用户进行gif图中的设置：</p>

<p><img src="https://i.imgur.com/PXM235L.gif" alt="enter image description here" /></p>

<h3 id="ios9ipa-bundle-id-">2. iOS9以后，企业分发时可能存在：下载的ipa包与网页两者的 bundle ID 无法匹配而导致下载失败的情况</h3>

<p>iOS9升级后众多企业分发的 app 已经出现了不能安装的情况，而iOS8或更早的系统不受影响。那是因为从iOS9以后，系统会在 ipa 包下载完之后，拿ipa包中的 bundle ID 与网页中的 plist 文件中的 bundle ID 进行比对，不一致不允许安装。</p>

<p>错误提示如下：</p>

<p><img src="http://i57.tinypic.com/28jckus.jpg" alt="enter image description here" /></p>

<p>网页中的 plist 文件中的 bundle ID 的作用可参考 <a href="http://blog.sina.com.cn/s/blog_6afb7d800101fa16.html">《iOS:苹果企业证书通过网页分发安装app》</a> 。</p>

<p>正如这篇文章提到的，“网页中的 plist 文件”是习惯的叫法，也有人称作“manifest文件”，比如 <a href="http://gknops.github.io/adHocGenerate/">这篇文章</a>。</p>

<p>而iOS9之前，苹果不会检查这一项，因此iOS9之前可以安装。</p>

<p>导致这一错误的原因除了粗心，还有开发者是故意设置不一致，据开发者说：</p>

<blockquote>
  <p>当初服务器 plist 的 bundle id 上故意做成成不一致。是为了解决一些人安装不上的问题。</p>
</blockquote>

<p>详情可参考： <a href="http://www.cocoachina.com/bbs/read.php?tid-324230-fpage-2-page-1.html">《升级到ios 9，企业版发布现在无法安装成功了，有人遇到了这种问题吗？》</a></p>

<p>如何知道是因为 bundle id 不一致造成的无法安装？</p>

<p>通过查看设备上的日志信息：有一个 itunesstored 进程提示安装信息：</p>

<pre><code>  itunesstored →  &lt;Warning&gt;: [Download]: Download task did finish: 8 for download: 2325728577585828282
  itunesstored →  &lt;Warning&gt;: [ApplicationWorkspace] Installing download: 2325728577585828282 with step(s): Install
  itunesstored →  &lt;Warning&gt;: [ApplicationWorkspace]: Installing software package with bundleID: com.***.***: bundleVersion: 1.01 path: /var/mobile/Media/Downloads/2325728577585828282/-1925357977307433048
  itunesstored →  &lt;Warning&gt;: BundleValidator: Failed bundleIdentifier: com.***.**** does not match expected bundleIdentifier: com.***.*********
  itunesstored →  &lt;Warning&gt;: [ApplicationWorkspace]: Bundle validated for bundleIdentifier: com.****.******success: 0
  itunesstored →  &lt;Warning&gt;: LaunchServices: Uninstalling placeholder for app &lt;LSApplicationProxy: 0x12677be70&gt; com.****.*******(Placeholder) &lt;file:///private/var/mobile/Containers/Bundle/Application/B62D8EA3-2052-4393-8A7E-3FD27228BFC2/2325728577585828282.app&gt;
  itunesstored →  &lt;Warning&gt;: LaunchServices: Uninstalling app &lt;LSApplicationProxy: 0x12677be70&gt; com.****.*****(Placeholder) &lt;file:///private/var/mobile/Containers/Bundle/Application/B62D8EA3-2052-4393-8A7E-3FD27228BFC2/2325728577585828282.app&gt;
</code></pre>

<p>其中的这一句很重要：</p>

<pre><code> itunesstored →  &lt;Warning&gt;: BundleValidator: Failed bundleIdentifier: com.***.**** does not match expected bundleIdentifier: com.***.*********
</code></pre>

<p>经过核对，果然是.ipa文件中真实的Bundle ID和manifest文件中配置的信息不匹配，然后测试发现：</p>

<blockquote>
  <p>iOS 9是校验bundle-identifier值的，而iOS 9以下版本是不校验，一旦iOS 9发现bundle-identifier不匹配，即使下载成功了，也会 Uninstall(日志中提示的)app的。</p>
</blockquote>

<p>适配方法：</p>

<ol>
  <li>两者的 bundle id 修改一致</li>
</ol>

<p>一旦出现iOS9能够安装企业版本APP，iOS9以下版本不能安装，一定先查看安装日志，然后核对每个参数配置。</p>

<p>manifest文件的参考配置。</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> ```XML
</span><span class='line'> <span class="ni">&amp;lt;</span>!DOCTYPE plist PUBLIC “-//Apple//DTD PLIST 1.0//EN”
</span><span class='line'>“http://www.apple.com/DTDs/PropertyList-1.0.dtd”<span class="ni">&amp;gt;</span><span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;dict&gt;</span>
</span><span class='line'>   <span class="c">&lt;!-- array of downloads. --&gt;</span>
</span><span class='line'>   <span class="nt">&lt;key&gt;</span>items<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>   <span class="nt">&lt;array&gt;</span>
</span><span class='line'>       <span class="nt">&lt;dict&gt;</span>
</span><span class='line'>           <span class="c">&lt;!-- an array of assets to download --&gt;</span>
</span><span class='line'>           <span class="nt">&lt;key&gt;</span>assets<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>           <span class="nt">&lt;array&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- software-package: the ipa to install. --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;dict&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- required.  the asset kind. --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>kind<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>software-package<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- optional.  md5 every n bytes.  --&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- will restart a chunk if md5 fails. --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>md5-size<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;integer&gt;</span>10485760<span class="nt">&lt;/integer&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- optional.  array of md5 hashes --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>md5s<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;array&gt;</span>
</span><span class='line'>                       <span class="nt">&lt;string&gt;</span>41fa64bb7a7cae5a46bfb45821ac8bba<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                       <span class="nt">&lt;string&gt;</span>51fa64bb7a7cae5a46bfb45821ac8bba<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;/array&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- required.  the URL of the file to download. --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>url<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>http://www.example.com/apps/foo.ipa<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="nt">&lt;/dict&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- display-image: the icon to display during download. --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;dict&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>kind<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>display-image<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- optional. icon needs shine effect applied. --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>needs-shine<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;true</span> <span class="nt">/&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>url<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>http://www.example.com/image.57×57.png<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="nt">&lt;/dict&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- full-size-image: the large 512×512 icon used by iTunes. --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;dict&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>kind<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>full-size-image<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                   <span class="c">&lt;!-- optional.  one md5 hash for the entire file. --&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>md5<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>61fa64bb7a7cae5a46bfb45821ac8bba<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>needs-shine<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;true</span> <span class="nt">/&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;key&gt;</span>url<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>                   <span class="nt">&lt;string&gt;</span>http://www.example.com/image.512×512.jpg<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="nt">&lt;/dict&gt;</span>
</span><span class='line'>           <span class="nt">&lt;/array&gt;&lt;key&gt;</span>metadata<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>           <span class="nt">&lt;dict&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- required --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;key&gt;</span>bundle-identifier<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>               <span class="nt">&lt;string&gt;</span>com.example.fooapp<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- optional (software only) --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;key&gt;</span>bundle-version<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>               <span class="nt">&lt;string&gt;</span>1.0<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- required.  the download kind. --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;key&gt;</span>kind<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>               <span class="nt">&lt;string&gt;</span>software<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- optional. displayed during download; --&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- typically company name --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;key&gt;</span>subtitle<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>               <span class="nt">&lt;string&gt;</span>Apple<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>               <span class="c">&lt;!-- required.  the title to display during the download. --&gt;</span>
</span><span class='line'>               <span class="nt">&lt;key&gt;</span>title<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>               <span class="nt">&lt;string&gt;</span>Example Corporate App<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>           <span class="nt">&lt;/dict&gt;</span>
</span><span class='line'>       <span class="nt">&lt;/dict&gt;</span>
</span><span class='line'>   <span class="nt">&lt;/array&gt;</span>
</span><span class='line'><span class="nt">&lt;/dict&gt;</span>
</span><span class='line'><span class="nt">&lt;/plist&gt;</span>
</span><span class='line'><span class="nt">&lt;p&gt;</span>```<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<ol>
  <li>使用fir.im等第三方分发平台：上述“ bundle id 不一致导致下载失败”这种情况只会出现在企业自己搭建网页分发的情形下，事实证明第三方的分发平台更加专业，已经很好地规避了该情况的发生。</li>
</ol>

<h3 id="q-a-1">Q-A</h3>

<p>Q：企业分发，企业版证书在iOS9上安装应用报 ` Ignore manifest download, already have bundleID: com.mycom.MyApp`  只有我的手机无法安装，别人 iOS9 都可以安装</p>

<p>A：这并非 iOS9的问题，iOS8及以前的系统也会出现，和缓存有关系，请尝试关机重启手机，然后就可以安装了。</p>

<h2 id="bitcode">4.Bitcode</h2>

<p>【前言】未来， Watch 应用必须包含 bitcode ，iOS不强制，Mac OS不支持。
但最坑的一点是： Xcode7 及以上版本会默认开启 bitcode 。</p>

<p>什么是 bitcode ？</p>

<p>通俗解释：在线版安卓ART模式。</p>

<p>Apple 官方文档–<a href="https://developer.apple.com/library/prerelease/ios/documentation/IDEs/Conceptual/AppDistributionGuide/AppThinning/AppThinning.html#//apple_ref/doc/uid/TP40012582-CH35"> <strong><em>App Distribution Guide – App Thinning (iOS, watchOS)</em></strong> </a>是这样定义的：</p>

<blockquote>
  <p>Bitcode is an intermediate representation of a compiled program. Apps you upload to iTunes Connect that contain bitcode will be compiled and linked on the App Store. Including bitcode will allow Apple to re-optimize your app binary in the future without the need to submit a new version of your app to the store.</p>
</blockquote>

<p>翻译过来就是：</p>

<blockquote>
  <p>bitcode 是被编译程序的一种中间形式的代码。包含 bitcode 配置的程序将会在 App Store 上被编译和链接。 bitcode 允许苹果在后期重新优化我们程序的二进制文件，而不需要我们重新提交一个新的版本到 App Store 上。</p>
</blockquote>

<p>在 Xcode简介— <a href="https://developer.apple.com/library/prerelease/ios/documentation/DeveloperTools/Conceptual/WhatsNewXcode/Articles/xcode_7_0.html"> <strong><em>What’s New in Xcode-New Features in Xcode 7</em></strong> </a>中这样描述：</p>

<blockquote>
  <p>Bitcode. When you archive for submission to the App Store, Xcode will compile your app into an intermediate representation. The App Store will then compile the bitcode down into the 64 or 32 bit executables as necessary.</p>
</blockquote>

<p>也就是</p>

<blockquote>
  <p>当我们提交程序到 App Store上时， Xcode 会将程序编译为一个中间表现形式( bitcode )。然后 App store 会再将这个 bitcode 编译为可执行的64位或32位程序。</p>
</blockquote>

<p>再看看这两段描述都是放在App Thinning(App瘦身)一节中，可以看出其与包的优化有关了。</p>

<p>打个比方，没有 bitcode  的 AppStore 里所提供的 App，类似在新华书店里卖捆绑销售的《四大名著丛书–精装版》，要买只能全买走，有了 bitcode 就好比这套四大名著每本都可以单卖，顾客就能按需购买。我们开发者在这个过程中扮演的角色是图书出版商的角色，应该照顾那些没钱一次买四本的顾客。（不要做不珍惜用户流量和存储空间的奸商。。）</p>

<p>那为什么第三方的 SDK 不支持 bitcode，我的 app 也就不能支持？打个比方，《四大名著丛书》只要有一本是可以单卖的，那么你很难再卖捆绑销售款的《四大名著丛书》了，所以干脆全都可以单卖，这大概就是 Apple 的逻辑。</p>

<p>App Thinning 官方文档解释如下：</p>

<blockquote>
  <p>The App Store and operating system optimize the installation of iOS and watchOS apps by tailoring app delivery to the capabilities of the user’s particular device, with minimal footprint. This optimization, called app thinning, lets you create apps that use the most device features, occupy minimum disk space, and accommodate future updates that can be applied by Apple. Faster downloads and more space for other apps and content provides a better user experience.</p>
</blockquote>

<p>开发者都知道，当前 iOS App 的编译打包方式是把适配兼容多个设备的执行文件及资源文件合并一个文件，上传和下载的文件则包含了所有的这些文件，导致占用较多的存储空间。</p>

<p>App Thinning是一个关于节省iOS设备存储空间的功能，它可以让iOS设备在安装、更新及运行App等场景中仅下载所需的资源，减少App的占用空间，从而节省设备的存储空间。</p>

<p>根据Apple官方文档的介绍，App Thinning主要有三个机制：</p>

<ol>
  <li>Slicing</li>
</ol>

<p>开发者把App安装包上传到AppStore后，Apple服务会自动对安装包切割为不同的应用变体(App variant)，当用户下载安装包时，系统会根据设备型号下载安装对应的单个应用变体。</p>

<ol>
  <li>On-Demand Resources</li>
</ol>

<p>ORD(随需资源)是指开发者对资源添加标签上传后，系统会根据App运行的情况，动态下载并加载所需资源，而在存储空间不足时，自动删除这类资源。</p>

<ol>
  <li>Bitcode
 开启Bitcode编译后，可以使得开发者上传App时只需上传Intermediate Representation(中间件)，而非最终的可执行二进制文件。 在用户下载App之前，AppStore会自动编译中间件，产生设备所需的执行文件供用户下载安装。</li>
</ol>

<p>（喵大(@onevcat)在其博客 <a href="http://onevcat.com/2015/06/ios9-sdk/">《开发者所需要知道的 iOS 9 SDK 新特性》</a> 中也描述了iOS 9中苹果在App瘦身中所做的一些改进，大家可以转场到那去研读一下。）</p>

<p>其中，Bitcode的机制可以支持动态的进行App Slicing，而对于Apple未来进行硬件升级的措施，此机制可以保证在开发者不重新发布版本的情况下而兼容新的设备。</p>

<p>Bitcode 是一种中间代码，那它是什么格式的呢？ LLVM 官方文档有介绍这种文件的格式：  <a href="http://llvm.org/docs/BitCodeFormat.html#llvm-bitcode-file-format"> <strong><em>LLVM Bitcode File Format</em></strong> </a> 。</p>

<p>如果你的应用也准备启用 Bitcode 编译机制，就需要注意以下几点：</p>

<ol>
  <li>Xcode 7默认开启 Bitcode ，如果应用开启 Bitcode，那么其集成的其他第三方库也需要是 Bitcode 编译的包才能真正进行 Bitcode 编译</li>
  <li>开启 Bitcode 编译后，编译产生的  <code>.app</code>  体积会变大(中间代码，不是用户下载的包)，且  <code>.dSYM</code>  文件不能用来崩溃日志的符号化(用户下载的包是 Apple 服务重新编译产生的，有产生新的符号文件)</li>
  <li>通过 Archive 方式上传 AppStore 的包，可以在Xcode的Organizer工具中下载对应安装包的新的符号文件</li>
</ol>

<p>如何适配？</p>

<p>在上面的错误提示中，提到了如何处理我们遇到的问题：</p>

<blockquote>
  <p>You must rebuild it with bitcode enabled (Xcode setting ENABLE_BITCODE), obtain an updated library from the vendor, or disable bitcode for this target. for architecture arm64</p>
</blockquote>

<p>正如开头所说的：</p>

<blockquote>
  <p>未来， Watch 应用必须包含 Bitcode ，iOS不强制，Mac OS不支持。
但最坑的一点是： Xcode7 及以上版本会默认开启 Bitcode 。</p>
</blockquote>

<p>Xcode 7 + 会开启 Bitcode。</p>

<p>也就是说，也两种方法适配：</p>

<p>方法一：更新 library 使包含 Bitcode ，否则会出现以下中的警告；</p>

<blockquote>
  <p>(null): URGENT: all bitcode will be dropped because
‘/Users/myname/Library/Mobile
Documents/com~apple~CloudDocs/foldername/appname/GoogleMobileAds.framework/GoogleMobileAds(GADSlot+AdEvents.o)’
was built without bitcode. You must rebuild it with bitcode enabled
(Xcode setting ENABLE_BITCODE), obtain an updated library from the
vendor, or disable bitcode for this target. Note: This will be an
error in the future.</p>
</blockquote>

<p>甚至有的会报错误，无法通过编译：</p>

<blockquote>
  <p>ld: ‘/Users/<strong>/Framework/SDKs/PolymerPay/Library/mobStat/lib</strong>SDK.a(**ForSDK.o)’ does not contain bitcode. You must rebuild it with bitcode enabled (Xcode setting ENABLE_BITCODE), obtain an updated library from the vendor, or disable bitcode for this target. for architecture arm64</p>
</blockquote>

<p>或：</p>

<blockquote>
  <p>ld: -undefined and -bitcode_bundle (Xcode setting  <code>ENABLE_BITCODE</code> =YES) cannot be used together
clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
</blockquote>

<p><img src="http://i62.tinypic.com/330vhug.jpg" alt="enter image description here" /></p>

<p>无论是警告还是错误，得到的信息是：我们引入的一个第三方库不包含bitcode。</p>

<p>方法二：关闭Bitcode，方法见下图</p>

<blockquote>
  <p><img src="https://i.imgur.com/OoOogUe.gif" alt="enter image description here" /></p>
</blockquote>

<p>我们可以在”Build Settings”-&gt;”Enable Bitcode”选项中看到：</p>

<p>用 Xcode 7+ 新建一个 iOS 程序时， bitcode 选项默认是设置为YES的。现在需要改成NO。</p>

<p>如果我们开启了 bitcode ，在提交包时，下面这个界面也会有个 bitcode 选项：</p>

<p><img src="http://i60.tinypic.com/5b2q7m.jpg" alt="enter image description here" /></p>

<p>那么 SDK 厂商如何支持 bitcode 呢？答案是只要在 Xcode7上重新编译一下就 ok 了。（请确保默认开启的 bitcode 没有去主动关闭）</p>

<p>但是如果仅仅是编译一下，则会出现下类似的如下警告：</p>

<p><img src="http://image17-c.poco.cn/mypoco/myphoto/20150928/17/1733887242015092817143106.jpg?1462x120_120" alt="enter image description here" /></p>

<blockquote>
  <p>ld: warning: full bitcode bundle could not be generated because ‘Lookback(Lookback.o)’ was built only with bitcode marker. The library must be generated from Xcode archive build with bitcode enabled (Xcode setting ENABLE_BITCODE)</p>
</blockquote>

<p>警告的消除步骤：</p>

<p>模拟器、真机分开打包，SDK在build的时候，让模拟器与真机分开build，模拟器不设置bitcode的参数，真机的加上，然后再合起来。（“合起来”指的是指令集，好比 x86_64 i386 跟 armv7 arm64合起来。）用命令行打包的话 加上这个参数OTHER_CFLAGS=“-fembed-bitcode”。</p>

<p>详情可移步：<a href="http://stackoverflow.com/a/31486233/3395008"> <strong><em>How do I xcodebuild a static library with Bitcode enabled?</em></strong> </a></p>

<p>更多信息，请移步</p>

<ol>
  <li><a href="https://developer.apple.com/library/prerelease/watchos/documentation/IDEs/Conceptual/AppDistributionGuide/AppThinning/AppThinning.html#//apple_ref/doc/uid/TP40012582-CH35-SW2">bitcode 苹果官方文档</a></li>
</ol>

<ol>
  <li>WWDC 2015 Session 102: <a href="https://developer.apple.com/videos/wwdc/2015/?id=102">“Platforms State of the Union”</a></li>
</ol>

<p><img src="http://mobileforward.net/wp-content/uploads/2015/06/Screen-Shot-2015-06-12-at-6.57.54-PM-697x351.png" alt="enter image description here" /></p>

<h2 id="demo3---ios9-url-scheme-">5.Demo3—iOS9 URL Scheme 适配_引入白名单概念</h2>

<p><a href="https://developer.apple.com/videos/wwdc/2015/?id=703"> <strong><em>WWDC 2015 Session 703: “Privacy and Your App</em></strong> </a> （ 时间在30：18左右）关于 <code>URL scheme</code> 的介绍，指出：</p>

<p><img src="https://i.imgur.com/2HxWQqq.png" alt="enter image description here" /></p>

<p>也就是说：在iOS9中，如果使用 <code>canOpenURL:</code> 方法，该方法所涉及到的  <code>URL scheme</code> 必须在”Info.plist”中将它们列为白名单，否则不能使用。key叫做LSApplicationQueriesSchemes ，键值内容是</p>

<pre><code>&lt;key&gt;LSApplicationQueriesSchemes&lt;/key&gt;
&lt;array&gt;
 &lt;string&gt;urlscheme&lt;/string&gt;
 &lt;string&gt;urlscheme2&lt;/string&gt;
 &lt;string&gt;urlscheme3&lt;/string&gt;
 &lt;string&gt;urlscheme4&lt;/string&gt;
&lt;/array&gt; 
</code></pre>

<p>白名单上限是50个：</p>

<p><a href="https://developer.apple.com/videos/wwdc/2015/?id=703"> <strong><em>WWDC 2015 Session 703: “Privacy and Your App</em></strong> </a> ）有说明：</p>

<blockquote>

  <p>“So for apps that are linked before iOS 9 and are running on iOS 9, they will be given 50 distinct URL schemes.”  –  WWDC 2015 session 703 Privacy and Your App</p>
</blockquote>

<p><del>
然而，我们却发现了一件意外的事：
当我们在 iOS9-beta（截至本文发布时，iOS9正式版还未发布）中，使用 `openURL:`  方法时，不在白名单中的 URL 会报错 &gt; “This app is not allowed to query for scheme xxx” 。
无论是官方文档还是 WWDC 的视频中都没有提及 `openURL:`  方法的这一变动，所以猜测这是 beta 版本一个 bug ，截至本文发布时，iOS9正式版还未发布，期望在正式版中能得以修复。在此之前，可通过将 `openURL:`  用到的 `URL scheme` 列入白名单来解决这个 bug 。（经测试：iOS9 beta5中已经修复）</del></p>

<p>iOS9中 <code>openURL:</code> 方法没有什么实质性的变化，仅仅多了一个确认动作：</p>

<p><img src="http://i57.tinypic.com/8zjh35.jpg" alt="enter image description here" /></p>

<p>苹果为什么要这么做？</p>

<p>在 iOS9 之前，你可以使用 <code>canOpenURL:</code> 监测用户手机里到底装没装微信，装没装微博。但是也有一些别有用心的 App ，这些 App 有一张常用 App 的 <code>URL scheme</code>，然后他们会多次调用<code>canOpenURL:</code> 遍历该表，来监测用户手机都装了什么 App ，比如这个用户装了叫“大姨妈”的App，你就可以知道这个用户是女性，你就可以只推给这个用户女性用品的广告。这是侵犯用户隐私的行为。</p>

<p>这也许就是原因。</p>

<p>本项目中给出了一个演示用的 Demo ，仓库的文件夹叫“Demo3_iOS9URLScheme适配_引入白名单概念”，Demo引用自<a href="https://github.com/gatzsche/LSApplicationQueriesSchemes-Working-Example"> <strong><em>LSApplicationQueriesSchemes-Working-Example</em></strong> </a></p>

<p>Demo结构如下：</p>

<p><img src="http://i61.tinypic.com/2hyyuqv.jpg" alt="enter image description here" /></p>

<p>主要演示的情景是这样的：</p>

<p>假设有两个App： weixin(微信) and 我的App. 我的App 想监测 weixin(微信) 是否被安装了. “weixin(微信)” 在 info.plist  中定义了 URL scheme :</p>

<pre><code>&lt;key&gt;CFBundleURLTypes&lt;/key&gt;
&lt;array&gt;
    &lt;dict&gt;
        &lt;key&gt;CFBundleURLSchemes&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;weixin&lt;/string&gt;
        &lt;/array&gt;
    &lt;/dict&gt;
&lt;/array&gt;
</code></pre>

<p>我的App 想监测 weixin(微信) 是否被安装了 ：</p>

<pre><code>[[UIApplication sharedApplication]
                    canOpenURL:[NSURL URLWithString:@"weixin(微信)://"]];
</code></pre>

<p>即使你安装了微信，在iOS9中，这有可能会返回NO：</p>

<p>因为你需要将 “weixin(微信)” 添加到 “我的App” 的 info.plist 文件中：</p>

<pre><code>&lt;key&gt;LSApplicationQueriesSchemes&lt;/key&gt;
&lt;array&gt;
    &lt;string&gt;weixin&lt;/string&gt;
&lt;/array&gt;
</code></pre>

<p>（以上只是为了演示，实际开发中，你不仅需要添加“weixin”还需要“wechat”这两个。具体下文给出表格）</p>

<p><del>关于 `openURL:` 这个问题，可在 Demo3 中自行测试，如果该 bug 修复了的话，请私信[微博@iOS程序犭袁](http://weibo.com/luohanchenyilong/)，我再来更新本文。（经测试：iOS9 beta5中已经修复）</del></p>

<p>另外，推荐一篇<a href="http://awkwardhare.com/post/121196006730/quick-take-on-ios-9-url-scheme-changes">博文</a>，其中最关键的是以下部分：</p>

<blockquote>
  <p>If you call the “canOpenURL” method on a URL that is not in your whitelist, it will return “NO”, even if there is an app installed that has registered to handle this scheme. A “This app is not allowed to query for scheme xxx” syslog entry will appear.</p>
</blockquote>

<p><del>&gt; If you call the “openURL” method on a URL that is not in your whitelist, it will fail silently. A “This app is not allowed to query for scheme xxx” syslog entry will appear.
</del></p>

<h3 id="url-scheme">常见 URL Scheme</h3>

<p>如果想一次性集成最常用的微信、新浪微博、QQ、支付宝四者的白名单，则配置如下：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>```XML<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;key&gt;</span>LSApplicationQueriesSchemes<span class="nt">&lt;/key&gt;</span>
</span><span class='line'><span class="nt">&lt;array&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- 微信 URL Scheme 白名单--&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>wechat<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>weixin<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- 新浪微博 URL Scheme 白名单--&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>sinaweibohd<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>sinaweibo<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>sinaweibosso<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>weibosdk<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>weibosdk2.5<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- QQ、Qzone URL Scheme 白名单--&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqapi<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqq<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqOpensdkSSoLogin<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqconnect<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkdataline<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkgrouptribeshare<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkfriend<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkapi<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkapiV2<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqopensdkapiV3<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneopensdk<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>wtloginmqq<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>wtloginmqq2<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqqwpa<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzone<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzonev2<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneshare<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>wtloginqzone<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzonewx<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneopensdkapiV2<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneopensdkapi19<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneopensdkapi<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>mqzoneopensdk<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- 支付宝  URL Scheme 白名单--&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>alipay<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>    <span class="nt">&lt;string&gt;</span>alipayshare<span class="nt">&lt;/string&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/array&gt;</span>
</span><span class='line'><span class="nt">&lt;p&gt;</span>```
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure></p>

<p>plist 文件看起来会是这样的：</p>

<p><img src="http://i58.tinypic.com/e5pyee.jpg" alt="enter image description here" /></p>

<p>其他平台可在下面的列表中查询：
各平台OpenURL白名单说明</p>

<table>
  <thead>
    <tr>
      <th>平台名称</th>
      <th>URL Schem</th>
      <th>补充说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>微信</td>
      <td>wechat,&lt;/p&gt; weixin</td>
      <td> </td>
    </tr>
    <tr>
      <td>支付宝</td>
      <td>alipay,&lt;/p&gt;alipayshare</td>
      <td> </td>
    </tr>
    <tr>
      <td>QQ</td>
      <td>mqqOpensdkSSoLogin, &lt;/p&gt;mqqopensdkapiV2,&lt;/p&gt;mqqopensdkapiV3,&lt;/p&gt;wtloginmqq2,&lt;/p&gt;mqq,&lt;/p&gt;mqqapi</td>
      <td> </td>
    </tr>
    <tr>
      <td>QZONE</td>
      <td>mqzoneopensdk, &lt;/p&gt;mqzoneopensdkapi,&lt;/p&gt;mqzoneopensdkapi19,&lt;/p&gt;mqzoneopensdkapiV2,&lt;/p&gt;mqqOpensdkSSoLogin,&lt;/p&gt;mqqopensdkapiV2,&lt;/p&gt;mqqopensdkapiV3,&lt;/p&gt;wtloginmqq2,&lt;/p&gt;mqqapi,&lt;/p&gt;mqqwpa，&lt;/p&gt;mqzone，&lt;/p&gt;mqq</td>
      <td>[注:若同时使用QQ和QZONE,则直接添加本格即可]</td>
    </tr>
    <tr>
      <td>新浪微博</td>
      <td>sinaweibo,&lt;/p&gt;sinaweibohd,&lt;/p&gt;sinaweibosso,&lt;/p&gt;sinaweibohdsso,&lt;/p&gt;weibosdk,&lt;/p&gt;weibosdk2.5</td>
      <td>[后两个若导入新浪SDK则需要]</td>
    </tr>
    <tr>
      <td>豆瓣</td>
      <td>无需配置</td>
      <td> </td>
    </tr>
    <tr>
      <td>开心网</td>
      <td>无需配置</td>
      <td> </td>
    </tr>
    <tr>
      <td>易信</td>
      <td>yixin,&lt;/p&gt; yixinopenapi</td>
      <td> </td>
    </tr>
    <tr>
      <td>Google+</td>
      <td>googlechrome, &lt;/p&gt;googlechrome-x-callback,&lt;/p&gt;hasgplus4,&lt;/p&gt;com.google.gppconsent,&lt;/p&gt;com.google.gppconsent.2.2.0,&lt;/p&gt;com.google.gppconsent.2.3.0,&lt;/p&gt;com.google.gppconsent.2.4.0,&lt;/p&gt;com.google.gppconsent.2.4.1</td>
      <td> </td>
    </tr>
    <tr>
      <td>人人网</td>
      <td>renrenapi,&lt;/p&gt;renrenios,&lt;/p&gt;renreniphone,&lt;/p&gt;renren,</td>
      <td> </td>
    </tr>
    <tr>
      <td>Facebook</td>
      <td>fbauth2</td>
      <td> </td>
    </tr>
    <tr>
      <td>Twitter</td>
      <td>无需配置</td>
      <td> </td>
    </tr>
    <tr>
      <td>Pocket</td>
      <td>pocket-oauth-v1</td>
      <td> </td>
    </tr>
    <tr>
      <td>Pinterest</td>
      <td>pinit</td>
      <td> </td>
    </tr>
    <tr>
      <td>Instagram</td>
      <td>instagram</td>
      <td> </td>
    </tr>
    <tr>
      <td>WhatsApp</td>
      <td>whatsapp</td>
      <td> </td>
    </tr>
    <tr>
      <td>Line</td>
      <td>line</td>
      <td> </td>
    </tr>
    <tr>
      <td>KakaoTalk</td>
      <td>kakaolink</td>
      <td> </td>
    </tr>
    <tr>
      <td>KaokaoStory</td>
      <td>storylink</td>
      <td> </td>
    </tr>
    <tr>
      <td>LinkedIn</td>
      <td>无需配置</td>
      <td> </td>
    </tr>
    <tr>
      <td>Tumblr</td>
      <td>无需配置</td>
      <td> </td>
    </tr>
    <tr>
      <td>非平台类</td>
      <td>无需配置</td>
      <td>( 如短信，复制，邮件等)</td>
    </tr>
  </tbody>
</table>

<h3 id="q-a-2">Q-A</h3>

<p>Q：我用xcode7编译的app，如果不在plist里面加scheme，ios9下qq就会不显示，因为我用了qqsdk里的判断是否安装qq的方法，我要是直接下载app store上的，没有加scheme，qq也是能显示。</p>

<p>A：本文中所罗列的新特性，多数情况下指的是 iOS9.X-SDK 新特性，AppStore 的版本是基于 iOS8.X-SDK或 iOS7.X-SDK，所以并不受 iOS9新特性约束。也就是说：<strong>Xcode7给iOS8打设备包不需要白名单也能调用“canOpenURL” ，Xcode7给iOS9设备打的包则不然，Xcode7和iOS9缺一不可，才需要适配URL Scheme。</strong></p>

<p>那么，如何确认自己项目所使用的 SDK？在Targets-&gt;Build Setting–&gt;Architectures</p>

<p><img src="http://i58.tinypic.com/amsa9u.jpg" alt="enter image description here" /></p>

<p>Q：我们自己的应用跳到微信、支付宝、微博等的URLScheme是固定几个，但是从微信、支付宝、微博跳回到我们的应用的URLScheme可能是成千上万个，那他们那些大厂是如何做这个白名单？</p>

<p>A：白名单策略影响的仅仅是 canOpenURL: 接口，OpenURL: 不受影响，这些大厂只调用 openURL: 所以不受 iOS9 的影响。</p>

<p>Q：文中提到了设置白名单的原因，然而，如果这些别有用心的APP在它自己的白名单列出它关心的APP, 然后依次调用canOpenURL来检测，照样可以监控用户都安装了哪些APP啊？所以我依然不明白苹果这样做得原因。</p>

<p>A：白名单的数目上限是50个。苹果这样子做，使得最多只能检测50个App。</p>

<p>Q：按照文中的适配方法，error原因就没有了的确没问题了，但是还是会打印如下信息：</p>

<p><code>Objective-C
 -canOpenURL: failed for URL: "XXXXXXXXXX" - error: "(null)"。
</code></p>

<p>A：这个模拟器的一个 bug，无论使用iOS9的真机还是模拟器均出现该问题，估计 Xcode 后续的升级中会修复掉。</p>

<p>那如何判断日志究竟是 Xcode bug 造成的还是没有适配造成的？看error的值，如果是null，则是 bug。（2015-09-21更）</p>

<h2 id="ipadslide-over--split-view">6. iPad适配Slide Over 和 Split View</h2>

<p><img src="http://cdn1.tnwcdn.com/wp-content/blogs.dir/1/files/2015/06/ew-.gif" alt="enter image description here" /></p>

<p>【iPad适配Slide Over 和 Split View】
若想适配multi tasking特性，唯一的建议：弃纯代码，改用storyboard、xib，纵观苹果WWDC所有Demo均是如此：</p>

<ol>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=218">Mysteries of Auto Layout, Part 1</a></p>
  </li>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=215">What’s New in Storyboards</a></p>
  </li>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=407">Implementing UI Designs in Interface Builder</a></p>
  </li>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=205">Getting Started with Multitasking on iPad in iOS 9</a></p>
  </li>
  <li>
    <p><a href="https://developer.apple.com/videos/wwdc/2015/?id=212">Optimizing Your App for Multitasking on iPad in iOS</a></p>
  </li>
</ol>

<h2 id="ui-">7.字体间隙变大导致 UI 显示异常</h2>

<p>iOS8中，字体是Helvetica，中文的字体有点类似于“华文细黑”。只是苹果手机自带渲染，所以看上去可能比普通的华文细黑要美观。iOS9中，中文系统字体变为了专为中国设计的“苹方” 有点类似于一种word字体“幼圆”。字体有轻微的加粗效果，并且最关键的是字体间隙变大了！</p>

<p>所以很多原本写死了width的label可能会出现“…”的情况：</p>

<table>
  <thead>
    <tr>
      <th>情况</th>
      <th>显示</th>
      <th>解释</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>XIB</td>
      <td>将 label 的 width 写死</td>
      <td>下面这两张图也可以直观的看出同一个界面，同一个label的变化。</td>
    </tr>
    <tr>
      <td>iOS8</td>
      <td><img src="http://images2015.cnblogs.com/blog/717809/201509/717809-20150919223903476-176844619.png" alt="enter image description here" /></td>
      <td>正常</td>
    </tr>
    <tr>
      <td>iOS9</td>
      <td><img src="http://images2015.cnblogs.com/blog/717809/201509/717809-20150919223918101-1917717144.png" alt="enter image description here" /></td>
      <td>最后四位数字、、、</td>
    </tr>
  </tbody>
</table>

<p>如果不将 label 的 width 写死，仅仅添加左端约束则右端的四个数字会越界</p>

<table>
  <thead>
    <tr>
      <th>情况</th>
      <th>显示</th>
      <th>解释</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>XIB</td>
      <td><img src="http://i60.tinypic.com/292r428.jpg" alt="enter image description here" /></td>
      <td>如果仅仅添加左端约束</td>
    </tr>
    <tr>
      <td>iOS8</td>
      <td><img src="http://i58.tinypic.com/2vj92bn.jpg" alt="enter image description here" /></td>
      <td>正常</td>
    </tr>
    <tr>
      <td>iOS9</td>
      <td><img src="http://i62.tinypic.com/2czaq1v.jpg" alt="enter image description here" /></td>
      <td>“3199”这四个数字越界了</td>
    </tr>
  </tbody>
</table>

<p>所以为了在界面显示上不出错，就算是固定长度的文字也还是建议使用sizetofit 或者ios向上取整 ceilf() 或者提前计算：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="bp">CGSize</span> <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">title</span> <span class="nl">sizeWithAttributes</span><span class="p">:</span><span class="l">@{</span><span class="nl">NSFontAttributeName</span><span class="p">:</span> <span class="p">[</span><span class="bp">UIFont</span> <span class="nl">systemFontOfSize</span><span class="p">:</span><span class="mf">14.0f</span><span class="p">]</span><span class="l">}</span><span class="p">];</span>
</span><span class='line'><span class="bp">CGSize</span> <span class="n">adjustedSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">ceilf</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">),</span> <span class="n">ceilf</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">));</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2 id="xcode7-">8.升级 Xcode7 后的崩溃与警告</h2>

<h3 id="sdk--ios9--crash">旧版本新浪微博 SDK 在 iOS9 上会导致的 Crash</h3>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="n">app</span> <span class="n">was</span> <span class="n">compiled</span> <span class="n">with</span> <span class="n">optimization</span> <span class="o">-</span> <span class="n">stepping</span> <span class="n">may</span> <span class="n">behave</span> <span class="n">oddly</span><span class="p">;</span> <span class="n">variables</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>打印出来这句话，然后崩溃。多是启动的过程中程序就崩溃。</p>

<p>在iOS9下，新浪微博SDK里面使用的 JSONKit 在部分机型可能导致崩溃。崩溃信息如下图。</p>

<p><img src="http://wiki.mob.com/wp-content/uploads/2015/09/4062130C-1138-4352-89AF-E518F189A851.png" alt="enter image description here" /></p>

<p>解决：更新新浪微博SDK，新浪的SDK最新版做了对iOS9兼容。</p>

<h3 id="ios9--masonry-">iOS9 下使用 Masonry 会引起崩溃的一种情况</h3>

<p>在 iOS8（及以前）我们有这样的经验：</p>

<blockquote>
  <p><code>leading 与 left</code>  、 <code>trailing 与 right</code>  在正常情况下是等价的 但是当一些布局是从右至左时(比如阿拉伯文?没有类似的经验) 则会对调，换句话说就是基本可以不理不用，用left和right就好了</p>
</blockquote>

<p>（摘自 <a href="http://adad184.com/2014/09/28/use-masonry-to-quick-solve-autolayout/">《Masonry介绍与使用实践(快速上手Autolayout)》</a> ）</p>

<p>但在概念里，还是一直将 leading 与 left 划为等号，这样做在 iOS8（及以前）上是正常的，但在 iOS9 上这样的观念可能会引起崩溃，比如：</p>

<p><code>Objective-C
 make.left.equalTo(self.mas_leading).offset(15);
</code></p>

<p>应该为：</p>

<p><code>Objective-C
 make.left.equalTo(self.mas_left).offset(15);
</code></p>

<p>同理 mas_training 也需要改为right</p>

<p>同时也有人反馈说也需要作如下调整否则也会崩溃：</p>

<p>toplayoutGuide 替换成 mas_toplayoutguide
bottomlayoutguide 替换成 mas_bottomlayoutguide</p>

<p>而且使用类似 <code>make.top.equalTo(topView.mas_baseline).with.offset(5);</code> 涉及 <code>mas_baseline</code> 的语句也会引起崩溃。</p>

<p>暂时的解决方案是</p>

<p>使用 <code>make.top.equalTo(self.mas_topLayoutGuide).with.offset(5);</code> 来替换原来的  <code>self.topLayoutGuide.mas_baseline</code>  反正效果是一样的</p>

<p>原来的代码：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">headerView</span> <span class="nl">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">UIView</span> <span class="o">*</span><span class="n">topView</span> <span class="o">=</span> <span class="p">(</span><span class="bp">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nb">self</span><span class="p">.</span><span class="n">topLayoutGuide</span><span class="p">;</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">top</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">topView</span><span class="p">.</span><span class="n">mas_baseline</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">leading</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_leading</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_right</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@34</span><span class="p">);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
修改后：
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">headerView</span> <span class="nl">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">top</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">mas_topLayoutGuide</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_left</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_right</span><span class="p">).</span><span class="n">with</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="n">make</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@34</span><span class="p">);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<h3 id="xcode-">Xcode 升级后，旧的状态栏的样式设置方式会引起警告</h3>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">error</span><span class="o">&gt;:</span> <span class="nl">CGContextSaveGState</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">context</span> <span class="mh">0x0</span><span class="p">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">see</span> <span class="n">the</span> <span class="n">backtrace</span><span class="p">,</span> <span class="n">please</span> <span class="n">set</span> <span class="n">CG_CONTEXT_SHOW_BACKTRACE</span> <span class="n">environmental</span> <span class="n">variable</span><span class="p">.</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">error</span><span class="o">&gt;:</span> <span class="nl">CGContextTranslateCTM</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">context</span> <span class="mh">0x0</span><span class="p">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">see</span> <span class="n">the</span> <span class="n">backtrace</span><span class="p">,</span> <span class="n">please</span> <span class="n">set</span> <span class="n">CG_CONTEXT_SHOW_BACKTRACE</span> <span class="n">environmental</span> <span class="n">variable</span><span class="p">.</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">error</span><span class="o">&gt;:</span> <span class="nl">CGContextRestoreGState</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">context</span> <span class="mh">0x0</span><span class="p">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">see</span> <span class="n">the</span> <span class="n">backtrace</span><span class="p">,</span> <span class="n">please</span> <span class="n">set</span> <span class="n">CG_CONTEXT_SHOW_BACKTRACE</span> <span class="n">environmental</span> <span class="n">variable</span><span class="p">.</span>
</span><span class='line'> <span class="err">```</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

出错原因：设置 app 的状态栏样式的时候，使用了旧的方式，在 info.plist 里面的 `View controller-based status bar appearance` 默认会为 YES，即使不设置也是 YES，但一般 iOS6 的时候为了设置状态栏样式，需要将其设为NO，iOS7，8也兼容，但是到了iOS9 就会报警告。

解决办法：

删除原先的设置代码，通常老的设置方式是这样的：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="c1">//设置状态栏的白色</span>
</span><span class='line'>    <span class="p">[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">setStatusBarStyle</span><span class="p">:</span><span class="n">UIStatusBarStyleLightContent</span><span class="p">];</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

删除的原因见下：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="c1">// Setting the statusBarStyle does nothing if your application is using the default UIViewController-based status bar system.</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="k">readwrite</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">UIStatusBarStyle</span> <span class="n">statusBarStyle</span> <span class="n">NS_DEPRECATED_IOS</span><span class="p">(</span><span class="mi">2</span><span class="n">_0</span><span class="p">,</span> <span class="mi">9</span><span class="n">_0</span><span class="p">,</span> <span class="s">&quot;Use -[UIViewController preferredStatusBarStyle]&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setStatusBarStyle:</span><span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="nv">statusBarStyle</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="n">NS_DEPRECATED_IOS</span><span class="p">(</span><span class="mi">2</span><span class="n">_0</span><span class="p">,</span> <span class="mi">9</span><span class="n">_0</span><span class="p">,</span> <span class="s">&quot;Use -[UIViewController preferredStatusBarStyle]&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

修改方式是在 `Info.plist` 文件中做如下修改：

将 `View controller-based status bar appearance` 删除（默认为 YES），或设置为YES：

对应的 plist 里的 XML源码：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> ```Objective-C
</span><span class='line'> <span class="nt">&lt;key&gt;</span>UIViewControllerBasedStatusBarAppearance<span class="nt">&lt;/key&gt;</span>
</span><span class='line'>	<span class="nt">&lt;true</span> <span class="nt">/&gt;</span>
</span><span class='line'> ```
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>
看起来长这样：

![enter image description here](http://i61.tinypic.com/jrsjnd.jpg)

然后使用新的方式来实现状态栏的样式：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="n">preferredStatusBarStyle</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nf">childViewControllerForStatusBarStyle</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNeedsStatusBarAppearanceUpdate</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>
比如，你想将状态栏设置为白色，就可以这样写：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="c1">//设置状态栏的白色</span>
</span><span class='line'> <span class="o">-</span><span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="n">preferredStatusBarStyle</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">UIStatusBarStyleLightContent</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>
记得要 clean 下或者删除应用程序重新运行

#### Demo4---navigationController状态栏样式新的设置方法

如果你按照上面的方法设置了，但还是不行。八成是 rootViewController 设置的问题，你必须设置 rootViewController，编译器才会去 rootViewController 中重载 preferredStatusBarStyle 方法。

另外当你在 appdelegate 中将 navigationController 设为 rootViewController 的时候：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'>     <span class="nb">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">;</span>
</span><span class='line'> <span class="err">```</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

因为 rootViewController 变为了 navigationController，你在 ViewController 里重写 preferredStatusBarStyle 方法是不会起作用的。所以最好的方法是

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">@&quot;微博@iOS程序犭袁&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">.</span><span class="n">navigationBar</span><span class="p">.</span><span class="n">barStyle</span> <span class="o">=</span> <span class="n">UIBarStyleBlack</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

如果你还是想重写 preferredStatusBarStyle 方法来达到作用，那最好使用分类来解决：

.h文件：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="c1">//</span>
</span><span class='line'><span class="c1">//  UINavigationController+StatusBarStyle.h</span>
</span><span class='line'><span class="c1">//  微博@iOS程序犭袁</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  Created by  https://github.com/ChenYilong/iOS9AdaptationTips/ on 15/6/8.</span>
</span><span class='line'><span class="c1">//  Copyright (c) 2015年   http://weibo.com/luohanchenyilong/  . All rights reserved.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &amp;lt;UIKit/UIKit.h&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="bp">UINavigationController</span> <span class="nl">(StatusBarStyle)</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>
.m文件：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'> <span class="c1">//</span>
</span><span class='line'><span class="c1">//  UINavigationController+StatusBarStyle.m</span>
</span><span class='line'><span class="c1">//  微博@iOS程序犭袁</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  Created by  https://github.com/ChenYilong/iOS9AdaptationTips/ on 15/6/8.</span>
</span><span class='line'><span class="c1">//  Copyright (c) 2015年   http://weibo.com/luohanchenyilong/  . All rights reserved.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;UINavigationController+StatusBarStyle.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="bp">UINavigationController</span> <span class="nl">(StatusBarStyle)</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">UIStatusBarStyle</span><span class="p">)</span><span class="nf">preferredStatusBarStyle</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//also you may add any fancy condition-based code here</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">UIStatusBarStyleLightContent</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

我在仓库里给出了 navigation 的设置方法，见Demo4。

参考链接： [preferredStatusBarStyle isn't called--For anyone using a UINavigationController:](http://stackoverflow.com/a/19513714/3395008) 

### Xcode7 在 debug 状态下也生成 .dSYM 文件引起的警告

Xcode6 的工程升级到 Xcode7上来，会报警告：

![enter image description here](http://i57.tinypic.com/2a5zuia.jpg)

这是 debug 编译时导出符号文件出现的告警，

然而新建的Xcode7工程不会有该问题。

解决方法是让 debug 编译的时候不生成符号文件：

![enter image description here](http://i60.tinypic.com/2e23qyp.jpg)

### Xcode7 无法使用 8.x 系统的设备调试，一运行就报错 `there is an intenal API error` 


![enter image description here](http://cdn.cocimg.com/bbs/attachment/Fid_21/21_296305_92094d6a71e587a.png)

`Xcode7` 调试  `iOS8.x` 的真机，需要确保项目名改为英文，中间含有中文会报错  `there is an intenal API error`

按照下面的步骤检查：

bulid settings  -&gt;    packaging  -&gt; product name   

### 使用了 HTML 的 iframe 元素可能导致无法从 Safari 跳转至 App 

我们都知道，从网易新闻分享一条新闻到QQ，然后从QQ中打开链接再用safari打开链接，在iOS8上，这个时候会跳转到网易新闻App。但是现在（2015年09月23日）版本的网易新闻在 iOS9 就不能正常跳转，会跳转到 App Store 页面并提示要不要打开 App Store。


这是很可能是因为使用了 HTML 的 iframe 元素，并将自定义的链接放进了该元素中

举例说明：

![enter image description here](http://i61.tinypic.com/2wbvok8.jpg)


我之前写的一个 Demo： [模仿 《简书 App》 的效果:在html中跳转到App中的对应页面,并能从App跳转到原来的网址](https://github.com/ChenYilong/CYLExternalURL)，在例子中直接调用自定义链接在 iOS9上是可以跳转到 App 中的，然而，如果用 iframe 元素包起来就会变不可用。

参考链接：


 1.  [HTML 的iframe 标签](http://www.w3school.com.cn/tags/tag_iframe.asp) 
 2.  [iOS 9 safari iframe src with custom url scheme not working](http://stackoverflow.com/questions/31891777/ios-9-safari-iframe-src-with-custom-url-scheme-not-working) 

### iOS9锁屏控制台会打印警告 

加入运行如下示例代码：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//在这个10秒内锁屏</span>
</span><span class='line'>         <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;准备休眠&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;打印成功&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>
应用运行过程中锁屏，总是会出现以下提示：
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">**</span> <span class="o">-</span><span class="p">[</span><span class="bp">UIApplication</span> <span class="nl">_handleNonLaunchSpecificActions</span><span class="p">:</span><span class="nl">forScene</span><span class="p">:</span><span class="nl">withTransitionContext</span><span class="p">:</span><span class="nl">completion</span><span class="p">:]</span> <span class="o">**</span> <span class="n">unhandled</span> <span class="n">action</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="nl">FBSSceneSnapshotAction</span><span class="p">:</span> <span class="mh">0x16da76c0</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">handler</span> <span class="o">=</span> <span class="n">remote</span><span class="p">;</span>
</span><span class='line'>    <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="nl">BSSettings</span><span class="p">:</span> <span class="mh">0x16d80e50</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

当应用处于空闲状态时（无网络请求）锁屏对于用户而言并无较大影响，


但是当应用在执行某个异步任务时（比如下拉刷新一下列表）锁屏，重新解锁进入就可能会发现异步任务失败，控制台也会提示 Error 信息：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">**</span> <span class="o">-</span><span class="p">[</span><span class="bp">UIApplication</span> <span class="nl">_handleNonLaunchSpecificActions</span><span class="p">:</span><span class="nl">forScene</span><span class="p">:</span><span class="nl">withTransitionContext</span><span class="p">:</span><span class="nl">completion</span><span class="p">:]</span> <span class="o">**</span> <span class="n">unhandled</span> <span class="n">action</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="nl">FBSSceneSnapshotAction</span><span class="p">:</span> <span class="mh">0x16da76c0</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">handler</span> <span class="o">=</span> <span class="n">remote</span><span class="p">;</span>
</span><span class='line'>    <span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="nl">BSSettings</span><span class="p">:</span> <span class="mh">0x16d80e50</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">error</span> <span class="k">in</span> <span class="nl">__connection_block_invoke_2</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">interrupted</span>
</span><span class='line'> <span class="err">```</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

以上情况不易复现，但确有发生。

在 iOS8 系统下测试并未发现此问题。

对此并未找到合理的解释和对应的解决办法，如果你有解决方法，欢迎提 PR !

### 在`didFinishLaunchingWithOptions`结束后还没有设置window的`rootViewController`会导致崩溃




 iOS9 不允许在 `didFinishLaunchingWithOptions` 结束了之后，还没有设置 window 的 `rootViewController` 。 也许是 Xcode7 的编译器本身就不支持。

崩溃时的控制台日志提示：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">***</span> <span class="n">Assertion</span> <span class="n">failure</span> <span class="k">in</span> <span class="o">-</span><span class="p">[</span><span class="bp">UIApplication</span> <span class="nl">_runWithMainScene</span><span class="p">:</span><span class="nl">transitionContext</span><span class="p">:</span><span class="nl">completion</span><span class="p">:],</span> <span class="o">/</span><span class="n">BuildRoot</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Caches</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">xbs</span><span class="o">/</span><span class="n">Sources</span><span class="o">/</span><span class="n">UIKit_Sim</span><span class="o">/</span><span class="n">UIKit</span><span class="o">-</span><span class="mf">3505.16</span><span class="o">/</span><span class="bp">UIApplication</span><span class="p">.</span><span class="nl">m</span><span class="p">:</span><span class="mi">3294</span>
</span><span class='line'>
</span><span class='line'><span class="o">***</span>  <span class="n">Terminating</span> <span class="n">app</span> <span class="n">due</span> <span class="n">to</span> <span class="n">uncaught</span> <span class="n">exception</span> <span class="err">&#39;</span><span class="n">NSInternalInconsistencyException</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">reason</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">Application</span> <span class="n">windows</span> <span class="n">are</span> <span class="n">expected</span> <span class="n">to</span> <span class="n">have</span> <span class="n">a</span> <span class="n">root</span> <span class="n">view</span> <span class="n">controller</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">application</span> <span class="n">launch</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">***</span> <span class="n">First</span> <span class="n">throw</span> <span class="n">call</span> <span class="nl">stack</span><span class="p">:</span>
</span><span class='line'><span class="cm">/*省略*/</span>
</span><span class='line'><span class="n">libc</span><span class="o">++</span><span class="n">abi</span><span class="p">.</span><span class="nl">dylib</span><span class="p">:</span> <span class="n">terminating</span> <span class="n">with</span> <span class="n">uncaught</span> <span class="n">exception</span> <span class="n">of</span> <span class="n">type</span> <span class="bp">NSException</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>
解决的方法是先设初始化个值，之后再赋值替换掉：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="bp">UIWindow</span> <span class="o">*</span><span class="n">window</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame</span><span class="p">:[</span><span class="n">UIScreenmainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">];</span>
</span><span class='line'><span class="n">window</span><span class="p">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>


尤其注意一种情况，在 iOS8以前，我们有时候会通过在 AppDelegate 中添加另一个 UIWindow ，并修改其 Level 来达到 addSubview 的效果，因而也不设置 window 的 `rootViewController` ，而是把它直接以视图的形式展示了，则在 iOS8 上是警告，在 iOS9 上就崩溃了。

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">application</span><span class="p">:(</span><span class="bp">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="nl">didFinishLaunchingWithOptions</span><span class="p">:(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">launchOptions</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame</span><span class="p">:[[</span><span class="bp">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">bounds</span><span class="p">]];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIColor</span> <span class="n">yellowColor</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">window</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">UIWindow</span> <span class="o">*</span><span class="n">normalWindow</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame</span><span class="p">:[[</span><span class="bp">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">bounds</span><span class="p">]];</span>
</span><span class='line'>    <span class="n">normalWindow</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIColor</span> <span class="n">blueColor</span><span class="p">];</span>
</span><span class='line'>    <span class="n">normalWindow</span><span class="p">.</span><span class="n">windowLevel</span> <span class="o">=</span> <span class="n">UIWindowLevelAlert</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">normalWindow</span> <span class="n">makeKeyAndVisible</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

这种情况，在 `didFinishLaunchingWithOptions` 需要修改原来的策略，将第二个 window 类型改为其他类型，比如 viewController 类型、navigation 类型、tabbarController 类型等。
 

## 9.Demo5、Demo6--- 搜索 API

导入两个 framework，

然后像设置tableView 的 cell 一样设置下每一个“搜索元素”，搜索元素的组成如下：


![enter image description here](http://i57.tinypic.com/144b22w.jpg)


详情见 Demo6 代码。


![enter image description here](http://image17-c.poco.cn/mypoco/myphoto/20150923/21/17338872420150923214730010.gif?370x686_110
)

既然刚才说了搜索元素与 tableView 的 cell 非常相似：那么我们就展示一下如何让 tableView 与 CoreSpotlightSearch 进行结合：

详见 Demo6，Demo6 与 Demo5 的主要差异在于：在点击搜索结果跳转到 App 后，还会进一步根据搜索的内容 push 到相应的详情页中：

![enter image description here](http://image17-c.poco.cn/mypoco/myphoto/20150924/00/17338872420150924001340035.gif?306x572_110
)

## 10.iOS国际化问题：当前设备语言字符串返回有变化。
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">bogus</span><span class="o">-</span><span class="n">wrapper</span><span class="err">&#39;</span><span class="o">&gt;&lt;</span><span class="n">notextile</span><span class="o">&gt;&lt;</span><span class="n">figure</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">code</span><span class="err">&#39;</span><span class="o">&gt;&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;highlight&quot;</span><span class="o">&gt;&lt;</span><span class="n">table</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;&lt;</span><span class="n">td</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;gutter&quot;</span><span class="o">&gt;&lt;</span><span class="n">pre</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;line-numbers&quot;</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="o">-</span><span class="n">number</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="o">-</span><span class="n">number</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="o">-</span><span class="n">number</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="mi">3</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="o">-</span><span class="n">number</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="mi">4</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="n">td</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">code</span><span class="err">&#39;</span><span class="o">&gt;&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;&#39;</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="bp">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">allLanguage</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="s">@&quot;AppleLanguages&quot;</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="bp">NSString</span> <span class="o">*</span><span class="n">currentLanguage</span> <span class="o">=</span> <span class="p">[</span><span class="n">allLanguage</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="k">class</span><span class="o">=</span><span class="err">&#39;</span><span class="n">line</span><span class="err">&#39;</span><span class="o">&gt;</span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;The current language is : %@&quot;</span><span class="p">,</span> <span class="n">currentLanguage</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;&lt;/</span><span class="n">figure</span><span class="o">&gt;&lt;/</span><span class="n">notextile</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
iOS 9 之前：以上返回结果：语言字符串代码。例如："zh-Hans"

iOS 9:以上返回结果：语言字符串代码 + 地区代码。例如："zh-Hans-US"

备注：  
1.请注意判断当前语言类型，不要用以下形式的代码了，不然在iOS9上就会遇到坑。

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if ([currentLanguage isEqualToString:@"zh-Hans"])</span></code></pre></td></tr></table></div></figure>

可以使用：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if ([currentLanguage hasPrefix:@"zh-Hans"])</span></code></pre></td></tr></table></div></figure>

另外：对于中文，语言有：

+ 简体中文:zh-Hans
+ 繁体中文:zh-Hant
+ 香港中文:zh-HK
+ 澳门中文:zh-MO
+ 台湾中文:zh-TW
+ 新加坡中文:zh-SG  



**备注：以上iOS9 当前语言字符串返回结果：语言字符串代码 + 地区代码。在某些情况下不是这样，本人手机型号：大陆版电信iPhone5S/A1533/16GB测试结果：zh-HK/zh-TW，在地区为"中国"、"中国香港"、"中国台湾"的时候，显示的还是zh-HK/zh-TW，一旦切换到其它地区，设备语言会自动的切换到中文繁体。请开发人员注意中文的问题！**





## 11.UITableView显示异常

原本在 Xcode6 上完好的项目，在 Xcode7 上一编译， `tableView` 出了两个问题 ：


 1.  代码创建的 `tableView` 无法隐藏 cell 分割线
 2.  `reloadData` 刷新失效；


### 代码创建的 `tableView` 无法隐藏 cell 分割线

iOS9 里面用到 tableView 突然跑出来了很多 cell 的分割线， 但是在用xib创建的 tableview，就不存在这个问题

解决方法是将设置分割线隐藏的方法 `self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;` 写在 `-layoutSubviews` 中：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">layoutSubviews</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">layoutSubviews</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="n">UITableViewCellSeparatorStyleNone</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="err">```</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

也有人发现另一种方法，就是每次 reloadData 之前都进行一次设置：设置分割线隐藏，这样也可以解决：

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="n">UITableViewCellSeparatorStyleNone</span><span class="p">;</span>
</span><span class='line'>   <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">]</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

虽然也可以解决但是不推荐，这样写会给其他人造成困扰：不知所云。


### `reloadData` 刷新失效

现象： `[tableView reloadData]` 无效，有一行 cell 明明改变了但是刷新不出来。


 感觉可能是这个方法和某种新加的特性冲突了，猜测可能是 `reloadData` 的操作被推迟到下一个 `RunLoop` 执行最终失效。

解决的方法是，注释 `[tableView reloadData]` ，改用局部刷新：
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="err">```</span><span class="n">Objective</span><span class="o">-</span><span class="n">C</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="nl">reloadSections</span><span class="p">:[</span><span class="bp">NSIndexSet</span> <span class="nl">indexSetWithIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="nl">withRowAnimation</span><span class="p">:</span><span class="n">UITableViewRowAnimationNone</span><span class="p">];</span>
</span><span class='line'> <span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>

这两个推测均属 Xcode7 的bug，将来 Apple 肯定会修复。


#结束语

疏漏之处，可前往阅读下[这个网站](http://asciiwwdc.com)，这里有每年 WWDC 演讲的英文记录。

----------


Posted by [微博@iOS程序犭袁](http://weibo.com/luohanchenyilong/)  
原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | [Creative Commons BY-NC-ND 3.0](http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)
</error></error></error>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[为什么要用Sketch]]></title>
    <link href="http://helloyokoy.github.io/blog/sketch/"/>
    <updated>2015-09-11T20:38:24+08:00</updated>
    <id>http://helloyokoy.github.io/blog/sketch</id>
    <content type="html"><![CDATA[<p>Jean-Marc Denis（原文作者，前Sparrow设计师，现在在Google工作）在参加WWDC 2013时认识了Sketch的开发团队，所以在第一时间尝试了Sketch，当时由于一些功能的缺失，所以还是折回去使用Photoshop了。过了一段时间，他发现设计师社区开始疯狂着迷于这款新的设计工具，所以决定再试一试，想看看迭代了一段时间的Sketch现在能完成多少原先他需要用Photoshop来做的工作。现在，他80%的设计工作都是由Sketch来完成的，所以写了这篇文章来帮助大家一起了解Sketch。</p>

<h4 id="photoshop">Photoshop并不是一款合适的界面设计工具</h4>

<p>为什么我们会期待一个新的设计工具？因为当我们更多的关注效率和关注协作，就越发现Photoshop已经不足以满足我们的期待了。下面看看具体的理由：</p>

<ul>
  <li>
    <p>并非为设计师打造</p>

    <p>Photoshop是为图像处理开发的，诸如路径和矢量工具都是后期才加上去的，所以如果你关心一下Photoshop的更新路径，用户界面设计师完全不是Adobe做这条产品时关心的用户群。所以，如果抛去那些复杂的功能，一个为用户界面设计师打造的设计工具完全可以做得更简单，更高效。</p>
  </li>
  <li>
    <p>不适合移动时代</p>

    <p>相信我们都会觉得为不同的设备输出不同分辨率的素材而痛苦不已吧。或许，你会使用一些第三方插件或是启用一些模板来处理这些事，但依然是很浪费时间的。</p>
  </li>
</ul>

<!--more-->

<ul>
  <li>
    <p>引擎太过陈旧</p>

    <p>Photoshop的引擎是上个世纪为图像处理而打造的，非常的耗费资源，即使是启动一下都要等很久，更别说一次移动多个分组了。话说回来，由于要兼顾Mac和Windows平台，能做到这样已经不容易了。</p>
  </li>
  <li>
    <p>越来越跟不上时代</p>

    <p>大公司的执行效率实在太低。不知道大伙是不是和我一样，非常痛苦地等了好几个月才等到Photoshop对Retina屏幕的支持。诸如自动对齐的等功能我已经不做期待了。</p>
  </li>
</ul>

<h4 id="sketch">为什么Sketch确实值得尝试</h4>
<ul>
  <li>
    <p>自动保存和多版本控制</p>

    <p>有没有梦想过拜托机械的手动保存？Sketch可以做到。Sketch在工作的时候会不断地自动保存成果，并且允许你回复到此前的任一版本。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*-4cYKm2z-PiOVFnk.png" alt="icon" /></p>

<ul>
  <li>
    <p>矢量作图并且像素级的完美</p>

    <p>矢量图意味着可以任意扩展。你没有必要不断地去调整素材的尺寸，Sketch会自动就帮你维持一个像素级完美的作品。如果有的时候你必须用像素点来作图，比如说是画图标或者是插画设计，Sketch 也提供了从矢量切换到像素视图的功能。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/1600/0*55Ko51isBD3VVcSL.png" alt="icon" /></p>

<ul>
  <li>
    <p>智能标尺</p>

    <p>你喜欢xScope吗？还是正在用选框工具来进行测量？又或者是难用的网格？Sketch的智能标尺可以帮你轻松地把设计元素的对齐方式、内外间距都调整完美。就我个人而言，这个功能非常节省时间而且避免了复杂的人工计算，是我觉得最有用的功能之一。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*DOaquv046FxhhUz6.gif" alt="icon" /></p>

<ul>
  <li>
    <p>随时随地编辑元素</p>

    <p>在Sketch里我们可以随时随地修改一个元素的圆角、高度和宽度。只需要简单地修改数值就可以轻松调整元素，对于刚从Photoshop切换过来的设计师而言非常好用。甚至会让你产生强烈的依赖。</p>
  </li>
  <li>
    <p>图形拼接</p>

    <p>在Sketch 里你可以很轻松地把多个图形合并，构成一个新的图形。并且Sketch在提供了多种图形合并模式的同时，还允许你随时修改已经合并图形的子图形。这项功能使得你可以很轻松地管理和创造更复杂的图形。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*4piteVCDqPNzWS3V.jpeg" alt="icon" /></p>

<ul>
  <li>
    <p>每个图层都可以有多种混合效果</p>

    <p>在Photoshop里想要让一个图层有多种混合效果是很困难的。但在Sketch里，你可以很容易给一个图层加上多种混合效果，看看下面的示例就知道了。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*UWRr3uQgedzzHtS6.png" alt="icon" /></p>

<ul>
  <li>
    <p>自动选择最接近的像素边界</p>

    <p>自动选择最接近的像素边界可以让一个图形或者是图层自动修正边距到一个像素级完善的位置。比如可以把一个宽度是5.3px的图形自动修正到5px，这样就不会有模糊的像素点和粗糙的图形了。我自己给这项功能设了一个快捷键（Command+Opitons+x），来确保我做出的每一个图形都像素级完美。这比人工一个一个按照网格修改图形高效得多。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*me1mYlEw5C1JKAKY.jpeg" alt="icon" /></p>

<ul>
  <li>样式链接
  有的时候你会做一些充斥文字的设计，样式链接可以帮助你设定一个固定的样式来快速地应用在新的文字上。如果你修改了其中任何一处的样式，那么所有链接该样式的文字都会自动更新到新的样式。并且，这项功能也可以应用在图形上。</li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/774/0*bTuYN8VIHPDImDXh.gif" alt="icon" /></p>

<ul>
  <li>
    <p>导出素材</p>

    <p>用Photoshop的时候，最痛苦的事莫过于切割元素，然后到处素材。Sketch则可以帮助你快速地导出各种分辨率和格式（pdf, eps, svg, png, jpg, tiff）的素材，通常导出只需要一个点击，并且不用借助任何第三方应用程序。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/914/0*Qjf-7dLH9R7H-yOk.png" alt="icon" /></p>

<ul>
  <li>
    <p>分布式布局</p>

    <p>作富文本设计的时候，布局会变得非常重要，这项功能可以帮助你快速地试验不同的方案。</p>
  </li>
  <li>
    <p>网格</p>

    <p>其实可以把网格功能理解成按照纵横两个维度自动地结构化布局内容。这个对于排版布局而言，非常方便。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*7TrwZwsBKN-hGLxk.jpeg" alt="icon" /></p>

<ul>
  <li>
    <p>出色的文字渲染</p>

    <p>Sketch的文字渲染引擎非常出色，可以用来做很出色的文字布局和字体设计。因此，你可以放心地放弃Photoshop的抗锯齿功能。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*2wahLljvKwgbT_Ws.png" alt="icon" /></p>

<ul>
  <li>
    <p>CSS样式导出</p>

    <p>如果你在做一些网页设计，Sketch可以帮助你快速地把你的成果到处成CSS样式。</p>
  </li>
</ul>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*qgh086TCiTWrVOl9.png" alt="icon" /></p>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/0*NxQ0xvJylnXQbGVm.png" alt="icon" /></p>

<ul>
  <li>
    <p>旋转副本</p>

    <p>这是一项小功能，但是确实可以节约你很多时间和精力。</p>
  </li>
  <li>
    <p>Sketch Mirror</p>

    <p>Sketch Mirror是一个Universal App，可以方便你在iPhone或是iPad上查看自己的成果。（作者撰写这个文章的时候Sketch还没有推出官方的镜像工具，所以这一段是译者补充的）。</p>
  </li>
</ul>

<h4 id="section">快速响应是杀手锏</h4>

<p>Sketch是一个小团队，发展非常快速。简单扫一眼Sketch的升级日志，你会发现每一个更新都会带来新的功能。 我非常建议你去使用Beta版本，你会见证Sketch快速的升级。 Sketch团队非常善于聆听用户的诉求，因而软件不断地变得更好。你可以去tenderapp上向他们提出新功能的要求。</p>

<h4 id="section-1">相关链接</h4>

<p><a href="http://www.bohemiancoding.com/download/sketch.zip">下载试用版</a></p>

<p><a href="http://www.bohemiancoding.com/sketch/buy">Mac App Store下载地址</a></p>

<p><a href="http://blog.mengto.com/topic/sketch/">Ment To 的博文</a></p>

<p><a href="http://sketchtips.tumblr.com/">Sketch 技巧分享博客</a></p>

<p><a href="http://www.sketchappsources.com/">Sketch 资源下载</a></p>

<p><a href="http://www.douban.com/group/sketchapp/">Sketch 豆瓣中文小组</a></p>

<p><a href="http://community.sketchcn.com/">Sketch 中文社区</a></p>

<hr />
<p>原文来自<a href="http://jianshu.io/p/7e8905b18620">http://jianshu.io/p/7e8905b18620</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MJExtension介绍]]></title>
    <link href="http://helloyokoy.github.io/blog/mjextensionjie-shao/"/>
    <updated>2015-08-10T10:35:13+08:00</updated>
    <id>http://helloyokoy.github.io/blog/mjextensionjie-shao</id>
    <content type="html"><![CDATA[<p><img src="https://camo.githubusercontent.com/7fb40e923eeafbf4a699b9c8a54f53d88f2a70b9/687474703a2f2f696d616765732e636e6974626c6f672e636f6d2f626c6f67323031352f3439373237392f3230313530352f3035313030343331363733363634312e706e67" alt="icon" title="icon" /></p>

<h2 id="mjextension">MJExtension</h2>

<blockquote>
  <p>The fastest, most convenient and most nonintrusive conversion between JSON and model.</p>
</blockquote>

<p>世界上转换速度最快、使用最简单方便的字典转模型框架</p>

<h2 id="getting-started">Getting Started【开始使用】</h2>

<h4 id="features">Features【能做什么】</h4>

<ul>
  <li>MJExtension是一套字典和模型之间互相转换的超轻量级框架</li>
  <li>JSON –&gt; Model、Core Data Model</li>
  <li>JSONString –&gt; Model、Core Data Model</li>
  <li>Model、Core Data Model –&gt; JSON</li>
  <li>JSON Array –&gt; Model Array、Core Data Model Array</li>
  <li>JSONString –&gt; Model Array、Core Data Model Array</li>
  <li>Model Array、Core Data Model Array –&gt; JSON Array</li>
  <li>Coding all properties of model in one line code.</li>
  <li>只需要一行代码，就能实现模型的所有属性进行Coding（归档和解档）</li>
</ul>

<!--more-->

<h4 id="why-use-mjextension-why-not-use-jsonmodel-or-mantle">Why use MJExtension, why not use JSONModel or Mantle</h4>

<h4 id="mjextension-is-faster-than-jsonmodel-and-mantle">MJExtension is faster than JSONModel and Mantle【转换速率】</h4>

<ul>
  <li>MJExtension &gt; JSONModel &gt; Mantle (Feel free to test it yourself)</li>
  <li>各位开发者也可以自行测试</li>
</ul>

<h4 id="mjextension-is-more-easy-to-gomjextension">MJExtension is more easy to go【MJExtension更加容易使用】</h4>

<ul>
  <li>
    <p>JSONModel</p>

    <ul>
      <li>You must let all model class extend JSONModel class</li>
      <li>要求所有模型类必须继承自JSONModel基类</li>
    </ul>
  </li>
  <li>
    <p>Mantle</p>

    <ul>
      <li>You must let all model class extend MTModel class.</li>
      <li>要求所有模型类必须继承自MTModel基类</li>
    </ul>
  </li>
  <li>
    <p>MJExtension</p>

    <ul>
      <li>Your model class doesn’t need to extend another base class. You don’t need to modify any model file. Nonintrusive, convenient.</li>
      <li>不需要你的模型类继承任何特殊基类，也不需要修改任何模型代码，毫无污染，毫无侵入性</li>
    </ul>
  </li>
</ul>

<h3 id="installation">Installation【安装】</h3>
<hr />

<h4 id="from-cocoapodscocoapods">From CocoaPods【使用CocoaPods】</h4>

<pre><code>pod 'MJExtension'
</code></pre>

<h4 id="manually">Manually【手动导入】</h4>

<ul>
  <li>Drag all source files under floder MJExtension to your project.【将MJExtension文件夹中的所有源代码拽入项目中】</li>
  <li>
    <p>Import the main header file：#import “MJExtension.h”【导入主头文件：#import “MJExtension.h”】</p>

    <pre><code>  MJExtension.h
  MJConst.h               MJConst.m
  MJFoundation.h          MJFoundation.m
  MJProperty.h            MJProperty.m
  MJType.h                MJType.m
  NSObject+MJCoding.h     NSObject+MJCoding.m
  NSObject+MJProperty.h   NSObject+MJProperty.m
  NSObject+MJKeyValue.h   NSObject+MJKeyValue.m
</code></pre>
  </li>
</ul>

<h3 id="examples">Examples【示例】</h3>
<hr />

<h4 id="the-most-simple-json---model">The most simple JSON -&gt; Model【最简单的字典转模型】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>typedef enum {
</span><span class='line'>   SexMale,
</span><span class='line'>   SexFemale
</span><span class='line'>} Sex;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface User : NSObject
</span><span class='line'>@property (copy, nonatomic) NSString *name;
</span><span class='line'>@property (copy, nonatomic) NSString *icon;
</span><span class='line'>@property (assign, nonatomic) unsigned int age;
</span><span class='line'>@property (copy, nonatomic) NSString *height;
</span><span class='line'>@property (strong, nonatomic) NSNumber *money;
</span><span class='line'>@property (assign, nonatomic) Sex sex;
</span><span class='line'>@property (assign, nonatomic, getter=isGay) BOOL gay;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>/&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>*****/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary *dict = @{
</span><span class='line'>   @”name” : @”Jack”,
</span><span class='line'>   @”icon” : @”lufy.png”,
</span><span class='line'>   @”age” : @20,
</span><span class='line'>   @”height” : @”1.55”,
</span><span class='line'>   @”money” : @100.9,
</span><span class='line'>   @”sex” : @(SexFemale),
</span><span class='line'>   @”gay” : @”true”
</span><span class='line'>//   @”gay” : @”1”
</span><span class='line'>//   @”gay” : @”NO”
</span><span class='line'>};&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// JSON -&gt; User
</span><span class='line'>User *user = [User objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSLog(@”name=%@, icon=%@, age=%zd, height=%@, money=%@, sex=%d, gay=%d”, user.name, user.icon, user.age, user.height, user.money, user.sex, user.gay);
</span><span class='line'>// name=Jack, icon=lufy.png, age=20, height=1.550000, money=100.9, sex=1&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="jsonstring---modeljson">JSONString -&gt; Model【JSON字符串转模型】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// 1.Define a JSONString
</span><span class='line'>NSString *jsonString = @”{"name":"Jack", "icon":"lufy.png", "age":20}”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// 2.JSONString -&gt; User
</span><span class='line'>User *user = [User objectWithKeyValues:jsonString];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// 3.Print user’s properties
</span><span class='line'>NSLog(@”name=%@, icon=%@, age=%d”, user.name, user.icon, user.age);
</span><span class='line'>// name=Jack, icon=lufy.png, age=20&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="model-contains-model">Model contains model【模型中嵌套模型】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface Status : NSObject
</span><span class='line'>@property (copy, nonatomic) NSString *text;
</span><span class='line'>@property (strong, nonatomic) User *user;
</span><span class='line'>@property (strong, nonatomic) Status *retweetedStatus;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>/&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>*****/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary *dict = @{
</span><span class='line'>   @”text” : @”Agree!Nice weather!”,
</span><span class='line'>   @”user” : @{
</span><span class='line'>       @”name” : @”Jack”,
</span><span class='line'>       @”icon” : @”lufy.png”
</span><span class='line'>   },
</span><span class='line'>   @”retweetedStatus” : @{
</span><span class='line'>       @”text” : @”Nice weather!”,
</span><span class='line'>       @”user” : @{
</span><span class='line'>           @”name” : @”Rose”,
</span><span class='line'>           @”icon” : @”nami.png”
</span><span class='line'>       }
</span><span class='line'>   }
</span><span class='line'>};&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// JSON -&gt; Status
</span><span class='line'>Status *status = [Status objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSString *text = status.text;
</span><span class='line'>NSString *name = status.user.name;
</span><span class='line'>NSString *icon = status.user.icon;
</span><span class='line'>NSLog(@”text=%@, name=%@, icon=%@”, text, name, icon);
</span><span class='line'>// text=Agree!Nice weather!, name=Jack, icon=lufy.png&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSString *text2 = status.retweetedStatus.text;
</span><span class='line'>NSString *name2 = status.retweetedStatus.user.name;
</span><span class='line'>NSString *icon2 = status.retweetedStatus.user.icon;
</span><span class='line'>NSLog(@”text2=%@, name2=%@, icon2=%@”, text2, name2, icon2);
</span><span class='line'>// text2=Nice weather!, name2=Rose, icon2=nami.png&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="model-contains-model-array">Model contains model-array【模型中有个数组属性，数组里面又要装着其他模型】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface Ad : NSObject
</span><span class='line'>@property (copy, nonatomic) NSString *image;
</span><span class='line'>@property (copy, nonatomic) NSString *url;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface StatusResult : NSObject
</span><span class='line'>/** Contatins status model */
</span><span class='line'>@property (strong, nonatomic) NSMutableArray *statuses;
</span><span class='line'>/** Contatins ad model */
</span><span class='line'>@property (strong, nonatomic) NSArray *ads;
</span><span class='line'>@property (strong, nonatomic) NSNumber *totalNumber;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>/&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>*****/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Tell MJExtension what type model will be contained in statuses and ads.
</span><span class='line'>[StatusResult setupObjectClassInArray:^NSDictionary *{
</span><span class='line'>  return @{
</span><span class='line'>                 @”statuses” : @”Status”,
</span><span class='line'>               // @”statuses” : [Status class],
</span><span class='line'>               @”ads” : @”Ad”
</span><span class='line'>               // @”ads” : [Ad class]
</span><span class='line'>           };
</span><span class='line'>}];
</span><span class='line'>// Equals: StatusResult.m implements +objectClassInArray method.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary *dict = @{
</span><span class='line'>   @”statuses” : @[
</span><span class='line'>                      @{
</span><span class='line'>                          @”text” : @”Nice weather!”,
</span><span class='line'>                          @”user” : @{
</span><span class='line'>                              @”name” : @”Rose”,
</span><span class='line'>                              @”icon” : @”nami.png”
</span><span class='line'>                          }
</span><span class='line'>                      },
</span><span class='line'>                      @{
</span><span class='line'>                          @”text” : @”Go camping tomorrow!”,
</span><span class='line'>                          @”user” : @{
</span><span class='line'>                              @”name” : @”Jack”,
</span><span class='line'>                              @”icon” : @”lufy.png”
</span><span class='line'>                          }
</span><span class='line'>                      }
</span><span class='line'>                  ],
</span><span class='line'>    @”ads” : @[
</span><span class='line'>                 @{
</span><span class='line'>                     @”image” : @”ad01.png”,
</span><span class='line'>                     @”url” : @”http://www.ad01.com”
</span><span class='line'>                 },
</span><span class='line'>                 @{
</span><span class='line'>                     @”image” : @”ad02.png”,
</span><span class='line'>                     @”url” : @”http://www.ad02.com”
</span><span class='line'>                 }
</span><span class='line'>             ],
</span><span class='line'>    @”totalNumber” : @”2014”
</span><span class='line'>};&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// JSON -&gt; StatusResult
</span><span class='line'>StatusResult *result = [StatusResult objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSLog(@”totalNumber=%@”, result.totalNumber);
</span><span class='line'>// totalNumber=2014&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Printing
</span><span class='line'>for (Status *status in result.statuses) {
</span><span class='line'>    NSString *text = status.text;
</span><span class='line'>    NSString *name = status.user.name;
</span><span class='line'>    NSString *icon = status.user.icon;
</span><span class='line'>    NSLog(@”text=%@, name=%@, icon=%@”, text, name, icon);
</span><span class='line'>}
</span><span class='line'>// text=Nice weather!, name=Rose, icon=nami.png
</span><span class='line'>// text=Go camping tomorrow!, name=Jack, icon=lufy.png&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Printing
</span><span class='line'>for (Ad *ad in result.ads) {
</span><span class='line'>   NSLog(@”image=%@, url=%@”, ad.image, ad.url);
</span><span class='line'>}
</span><span class='line'>// image=ad01.png, url=http://www.ad01.com
</span><span class='line'>// image=ad02.png, url=http://www.ad02.com&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="model-name---json-key-mappingkey">Model name - JSON key mapping【模型中的属性名和字典中的key不相同(或者需要多级映射)】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface Bag : NSObject
</span><span class='line'>@property (copy, nonatomic) NSString *name;
</span><span class='line'>@property (assign, nonatomic) double price;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface Student : NSObject
</span><span class='line'>@property (copy, nonatomic) NSString *ID;
</span><span class='line'>@property (copy, nonatomic) NSString *desc;
</span><span class='line'>@property (copy, nonatomic) NSString *nowName;
</span><span class='line'>@property (copy, nonatomic) NSString *oldName;
</span><span class='line'>@property (copy, nonatomic) NSString *nameChangedTime;
</span><span class='line'>@property (strong, nonatomic) Bag *bag;
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>/&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>*****/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// How to map
</span><span class='line'>[Student setupReplacedKeyFromPropertyName:^NSDictionary *{
</span><span class='line'>   return @{
</span><span class='line'>               @”ID” : @”id”,
</span><span class='line'>               @”desc” : @”desciption”,
</span><span class='line'>               @”oldName” : @”name.oldName”,
</span><span class='line'>               @”nowName” : @”name.newName”,
</span><span class='line'>               @”nameChangedTime” : @”name.info[1].nameChangedTime”,
</span><span class='line'>               @”bag” : @”other.bag”
</span><span class='line'>           };
</span><span class='line'>}];
</span><span class='line'>// Equals: Student.m implements +replacedKeyFromPropertyName method.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary *dict = @{
</span><span class='line'>    @”id” : @”20”,
</span><span class='line'>    @”desciption” : @”kids”,
</span><span class='line'>    @”name” : @{
</span><span class='line'>        @”newName” : @”lufy”,
</span><span class='line'>        @”oldName” : @”kitty”,
</span><span class='line'>        @”info” : @[
</span><span class='line'>                 @”test-data”,
</span><span class='line'>                 @{
</span><span class='line'>                             @”nameChangedTime” : @”2013-08”
</span><span class='line'>                         }
</span><span class='line'>                  ]
</span><span class='line'>  },
</span><span class='line'>    @”other” : @{
</span><span class='line'>        @”bag” : @{
</span><span class='line'>            @”name” : @”a red bag”,
</span><span class='line'>            @”price” : @100.7
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>};&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// JSON -&gt; Student
</span><span class='line'>Student *stu = [Student objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Printing
</span><span class='line'>NSLog(@”ID=%@, desc=%@, oldName=%@, nowName=%@, nameChangedTime=%@”,
</span><span class='line'>      stu.ID, stu.desc, stu.oldName, stu.nowName, stu.nameChangedTime);
</span><span class='line'>// ID=20, desc=kids, oldName=kitty, nowName=lufy, nameChangedTime=2013-08
</span><span class='line'>NSLog(@”bagName=%@, bagPrice=%f”, stu.bag.name, stu.bag.price);
</span><span class='line'>// bagName=a red bag, bagPrice=100.700000&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="json-array---model-array">JSON array -&gt; model array【将一个字典数组转成模型数组】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSArray *dictArray = @[
</span><span class='line'>                         @{
</span><span class='line'>                             @”name” : @”Jack”,
</span><span class='line'>                             @”icon” : @”lufy.png”
</span><span class='line'>                         },
</span><span class='line'>                         @{
</span><span class='line'>                             @”name” : @”Rose”,
</span><span class='line'>                             @”icon” : @”nami.png”
</span><span class='line'>                         }
</span><span class='line'>                    ];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// JSON array -&gt; User array
</span><span class='line'>NSArray *userArray = [User objectArrayWithKeyValuesArray:dictArray];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Printing
</span><span class='line'>for (User *user in userArray) {
</span><span class='line'>   NSLog(@”name=%@, icon=%@”, user.name, user.icon);
</span><span class='line'>}
</span><span class='line'>// name=Jack, icon=lufy.png
</span><span class='line'>// name=Rose, icon=nami.png&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="model---json">Model -&gt; JSON【将一个模型转成字典】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// New model
</span><span class='line'>User *user = [[User alloc] init];
</span><span class='line'>user.name = @”Jack”;
</span><span class='line'>user.icon = @”lufy.png”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>Status *status = [[Status alloc] init];
</span><span class='line'>status.user = user;
</span><span class='line'>status.text = @”Nice mood!”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Status -&gt; JSON
</span><span class='line'>NSDictionary &lt;em>statusDict = status.keyValues;
</span><span class='line'>NSLog(@”%@”, statusDict);
</span><span class='line'>/&lt;/em>
</span><span class='line'>{
</span><span class='line'> 	text = “Nice mood!”;
</span><span class='line'> 	user =     {
</span><span class='line'> 	icon = “lufy.png”;
</span><span class='line'> 	name = Jack;
</span><span class='line'> 	};
</span><span class='line'>}
</span><span class='line'>*/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// More complex situation
</span><span class='line'>Student *stu = [[Student alloc] init];
</span><span class='line'>stu.ID = @”123”;
</span><span class='line'>stu.oldName = @”rose”;
</span><span class='line'>stu.nowName = @”jack”;
</span><span class='line'>stu.desc = @”handsome”;
</span><span class='line'>stu.nameChangedTime = @”2018-09-08”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>Bag *bag = [[Bag alloc] init];
</span><span class='line'>bag.name = @”a red bag”;
</span><span class='line'>bag.price = 205;
</span><span class='line'>stu.bag = bag;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary &lt;em>stuDict = stu.keyValues;
</span><span class='line'>NSLog(@”%@”, stuDict);
</span><span class='line'>/&lt;/em>
</span><span class='line'>{
</span><span class='line'>   ID = 123;
</span><span class='line'>   bag =     {
</span><span class='line'>        name = “\U5c0f\U4e66\U5305”;
</span><span class='line'>        price = 205;
</span><span class='line'> };
</span><span class='line'>   desc = handsome;
</span><span class='line'>   nameChangedTime = “2018-09-08”;
</span><span class='line'>   nowName = jack;
</span><span class='line'>   oldName = rose;
</span><span class='line'>}
</span><span class='line'>*/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="model-array---json-array">Model array -&gt; JSON array【将一个模型数组转成字典数组】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// New model array
</span><span class='line'>User *user1 = [[User alloc] init];
</span><span class='line'>user1.name = @”Jack”;
</span><span class='line'>user1.icon = @”lufy.png”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>User *user2 = [[User alloc] init];
</span><span class='line'>user2.name = @”Rose”;
</span><span class='line'>user2.icon = @”nami.png”;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSArray *userArray = @[user1, user2];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Model array -&gt; JSON array
</span><span class='line'>NSArray &lt;em>dictArray = [User keyValuesArrayWithObjectArray:userArray];
</span><span class='line'>NSLog(@”%@”, dictArray);
</span><span class='line'>/&lt;/em>
</span><span class='line'> (
</span><span class='line'> {
</span><span class='line'> 	icon = “lufy.png”;
</span><span class='line'>	name = Jack;
</span><span class='line'>},
</span><span class='line'> {
</span><span class='line'> 	icon = “nami.png”;
</span><span class='line'> 	name = Rose;
</span><span class='line'> }
</span><span class='line'>)
</span><span class='line'>*/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="core-data">Core Data</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSDictionary *dict = @{
</span><span class='line'>                         @”name” : @”Jack”,
</span><span class='line'>                         @”icon” : @”lufy.png”,
</span><span class='line'>                         @”age” : @20,
</span><span class='line'>                         @”height” : @1.55,
</span><span class='line'>                         @”money” : @”100.9”,
</span><span class='line'>                         @”sex” : @(SexFemale),
</span><span class='line'>                         @”gay” : @”true”
</span><span class='line'>                     };&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// This demo just provide simple steps
</span><span class='line'>NSManagedObjectContext *context = nil;
</span><span class='line'>User *user = [User objectWithKeyValues:dict context:context];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>[context save:nil];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="coding">Coding</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1 id="import-mjextensionh">import “MJExtension.h”&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>@implementation Bag
</span><span class='line'>// NSCoding Implementation
</span><span class='line'>MJCodingImplementation
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>/&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>&lt;strong>**&lt;/strong>*****/&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// what properties not to be coded
</span><span class='line'>[Bag setupIgnoredCodingPropertyNames:^NSArray *{
</span><span class='line'>   return @[@”name”];
</span><span class='line'>}];
</span><span class='line'>// Equals: Bag.m implements +ignoredCodingPropertyNames method.&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Create model
</span><span class='line'>Bag *bag = [[Bag alloc] init];
</span><span class='line'>bag.name = @”Red bag”;
</span><span class='line'>bag.price = 200.8;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>NSString *file = [NSHomeDirectory() stringByAppendingPathComponent:@”Desktop/	bag.data”];
</span><span class='line'>// Encoding
</span><span class='line'>[NSKeyedArchiver archiveRootObject:bag toFile:file];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Decoding
</span><span class='line'>Bag *decodedBag = [NSKeyedUnarchiver unarchiveObjectWithFile:file];
</span><span class='line'>NSLog(@”name=%@, price=%f”, decodedBag.name, decodedBag.price);
</span><span class='line'>// name=(null), price=200.800000&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="camel---underline">Camel -&gt; underline【统一转换属性名（比如驼峰转下划线）】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Dog
</span><span class='line'>#import “MJExtension.h”&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@implementation Dog
</span><span class='line'>+ (NSString *)replacedKeyFromPropertyName121:(NSString *)propertyName
</span><span class='line'>{
</span><span class='line'>   // nickName -&gt; nick_name
</span><span class='line'>   return [propertyName underlineFromCamel];
</span><span class='line'>}
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// NSDictionary
</span><span class='line'>NSDictionary *dict = @{
</span><span class='line'>                       @”nick_name” : @”旺财”,
</span><span class='line'>                       @”sale_price” : @”10.5”,
</span><span class='line'>                       @”run_speed” : @”100.9”
</span><span class='line'>                     };
</span><span class='line'>// NSDictionary -&gt; Dog
</span><span class='line'>Dog *dog = [Dog objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// printing
</span><span class='line'>NSLog(@”nickName=%@, scalePrice=%f runSpeed=%f”, dog.nickName, dog.salePrice, dog.runSpeed);&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h4 id="nsstring---nsdate-nil---nsdatenil">NSString -&gt; NSDate, nil -&gt; @”“【过滤字典的值（比如字符串日期处理为NSDate、字符串nil处理为@”“）】</h4>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// Book
</span><span class='line'>#import “MJExtension.h”&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@implementation Book
</span><span class='line'>- (id)newValueFromOldValue:(id)oldValue property:(MJProperty *)property
</span><span class='line'>{
</span><span class='line'>  if ([property.name isEqualToString:@”publisher”]) {
</span><span class='line'>        if (oldValue == nil) return @””;
</span><span class='line'>  } else if (property.type.typeClass == [NSDate class]) {
</span><span class='line'>        NSDateFormatter *fmt = [[NSDateFormatter alloc] init];
</span><span class='line'>        fmt.dateFormat = @”yyyy-MM-dd”;
</span><span class='line'>        return [fmt dateFromString:oldValue];
</span><span class='line'>  }&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>return oldValue;
</span><span class='line'>}
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// NSDictionary
</span><span class='line'>NSDictionary *dict = @{
</span><span class='line'>                       @”name” : @”5分钟突破iOS开发”,
</span><span class='line'>                       @”publishedTime” : @”2011-09-10”
</span><span class='line'>                       };
</span><span class='line'>// NSDictionary -&gt; Book
</span><span class='line'>Book *book = [Book objectWithKeyValues:dict];&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>// printing
</span><span class='line'>NSLog(@”name=%@, publisher=%@, publishedTime=%@”, book.name, book.publisher, book.publishedTime);&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<h3 id="more-use-cases">More use cases【更多用法】</h3>

<ul>
  <li>Please reference to NSObject+MJKeyValue.h and NSObject+MJCoding.h</li>
  <li><a href="https://github.com/CoderMJLee/MJExtension" title="url">github地址</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS 依赖注入框架 Objection]]></title>
    <link href="http://helloyokoy.github.io/blog/iosyi-lai-zhu-ru-kuang-jia-objection/"/>
    <updated>2015-07-10T21:52:44+08:00</updated>
    <id>http://helloyokoy.github.io/blog/iosyi-lai-zhu-ru-kuang-jia-objection</id>
    <content type="html"><![CDATA[<blockquote>
  <p>objection 是一个轻量级的依赖注入框架，受Guice的启发，Google Wallet 也是使用的该项目。「依赖注入」是面向对象编程的一种设计模式，用来减少代码之间的耦合度。通常基于接口来实现，也就是说不需要new一个对象，而是通过相关的控制器来获取对象。2013年最火的PHP框架 laravel 就是其中的典型。</p>
</blockquote>

<p>假设有以下场景：ViewControllerA.view里有一个button，点击之后push一个ViewControllerB，最简单的写法类似这样：</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;ul>
</span><span class='line'>  &lt;li>
</span><span class='line'>    &lt;p>(void)viewDidLoad
</span><span class='line'>{
</span><span class='line'>  [super viewDidLoad];
</span><span class='line'>  UIButton *button = [UIButton buttonWithType:UIButtonTypeSystem];
</span><span class='line'>  button.frame = CGRectMake(100, 100, 100, 30);
</span><span class='line'>  [self.view addSubview:button];
</span><span class='line'>}&lt;/p>
</span><span class='line'>  &lt;/li>
</span><span class='line'>  &lt;li>
</span><span class='line'>    &lt;p>(void)buttonTapped
</span><span class='line'>{
</span><span class='line'>  ViewControllerB *vc = [[ViewControllerB alloc] init];
</span><span class='line'>  [self.navigationController pushViewController:vc animated:YES];
</span><span class='line'>}&lt;/p>
</span><span class='line'>  &lt;/li>
</span><span class='line'>&lt;/ul>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<p>这样写的一个问题是，ViewControllerA需要import ViewControllerB，也就是对ViewControllerB产生了依赖。依赖的东西越多，维护起来就越麻烦，也容易出现循环依赖的问题，而objection正好可以处理这些问题。</p>

<!--more-->

<p>实现方法是：先定义一个协议(protocol)，然后通过objection来注册这个协议对应的class，需要的时候，可以获取该协议对应的object。对于使用方无需关心到底使用的是哪个Class，反正该有的方法、属性都有了(在协议中指定)。这样就去除了对某个特定Class的依赖。也就是通常所说的「面向接口编程」。</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>JSObjectionInjector *injector = [JSObjection defaultInjector]; // [1]
</span><span class='line'>UIViewController &lt;viewcontrolleraprotocol> *vc = [injector getObject:@protocol(ViewControllerAProtocol)]; // [2]
</span><span class='line'>vc.backgroundColor = [UIColor lightGrayColor]; // [3]
</span><span class='line'>UINavigationController *nc = [[UINavigationController alloc] initWithRootViewController:vc];
</span><span class='line'>self.window.rootViewController = nc;&lt;/viewcontrolleraprotocol>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<ol>
  <li>获取默认的injector，这个injector已经注册过ViewControllerAProtocol了。</li>
  <li>获取ViewControllerAProtocol对应的Object。</li>
  <li>拿到VC后，设置它的某些属性，比如这里的backgroundColor，因为在ViewControllerAProtocol里有定义这个属性，所以不会有warning。</li>
</ol>

<p>可以看到这里没有引用ViewControllerA。再来看看这个ViewControllerAProtocol是如何注册到injector中的，这里涉及到了Module，对Protocol的注册都是在Module中完成的。Module只要继承JSObjectionModule这个Class即可。</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface ViewControllerAModule : JSObjectionModule
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@implementation ViewControllerAModule
</span><span class='line'>- (void)configure
</span><span class='line'>{
</span><span class='line'>   [self bindClass:[ViewControllerA class] toProtocol:@protocol(ViewControllerAProtocol)];
</span><span class='line'>}
</span><span class='line'>@end&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<p>绑定操作是在configure方法里进行的，这个方法在被添加到injector里时会被自动触发。</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>JSObjectionInjector *injector = [JSObjection defaultInjector]; // [1]
</span><span class='line'>injector = injector ? : [JSObjection createInjector]; // [2]
</span><span class='line'>injector = [injector withModule:[[ViewControllerAModule alloc] init]]; // [3]
</span><span class='line'>[JSObjection setDefaultInjector:injector]; // [4]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<ol>
  <li>获取默认的 injector</li>
  <li>如果默认的 injector 不存在，就新建一个</li>
  <li>往这个 injector 里注册我们的 Module</li>
  <li>设置该 injector 为默认的 injector</li>
</ol>

<p>这段代码可以直接放到 + (void)load里执行，这样就可以避免在AppDelegate里import各种Module。</p>

<p>因为我们无法直接获得对应的Class，所以必须要在协议里定义好对外暴露的方法和属性，然后该Class也要实现该协议。</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@protocol ViewControllerAProtocol &lt;nsobject>
</span><span class='line'>@property (nonatomic) NSUInteger currentIndex;
</span><span class='line'>@property (nonatomic) UIColor *backgroundColor;
</span><span class='line'>@end&lt;/nsobject>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>@interface ViewControllerA : UIViewController &lt;viewcontrolleraprotocol>
</span><span class='line'>@end&lt;/viewcontrolleraprotocol>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></p>

<p>通过objection实现依赖注入后，就能更好地实现SRP(Single Responsibility Principle)，代码更简洁，心情更舒畅，生活更美好。</p>

<hr />
<p>github地址: <a href="https://github.com/atomicobject/objection" title="url">https://github.com/atomicobject/objection</a></p>

<p>demo地址: <a href="https://github.com/helloyokoy/bizhi" title="url">https://github.com/helloyokoy/bizhi</a></p>
]]></content>
  </entry>
  
</feed>
